<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SocialBook</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
                        dark: { 100: '#18191a', 200: '#242526', 300: '#3a3b3c', 400: '#4e4f50', 500: '#65676b', 600: '#b0b3b8', 700: '#e4e6eb' }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #65676b; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #8a8d91; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes ring { 0%, 100% { transform: rotate(-10deg); } 50% { transform: rotate(10deg); } }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }
        
        .fade-in { animation: fadeIn 0.3s ease; }
        .slide-up { animation: slideUp 0.3s ease; }
        .slide-in { animation: slideIn 0.3s ease; }
        
        /* Chat Window */
        .chat-window {
            width: 328px;
            height: 450px;
            box-shadow: 0 12px 28px 0 rgba(0,0,0,0.2), 0 2px 4px 0 rgba(0,0,0,0.1);
            border-radius: 8px 8px 0 0;
            display: flex;
            flex-direction: column;
            transition: height 0.2s ease;
        }
        .chat-window.minimized { height: 44px; }
        .chat-window.minimized .chat-body,
        .chat-window.minimized .chat-footer { display: none; }
        
        /* Typing indicator */
        .typing-dot { 
            width: 8px; height: 8px; 
            background: #65676b; 
            border-radius: 50%; 
            animation: bounce 1.4s ease-in-out infinite; 
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        /* Story ring */
        .story-ring {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            padding: 3px;
            border-radius: 50%;
        }
        
        /* Call animation */
        .call-ring { animation: ring 0.5s ease-in-out infinite; }
        .ripple::before, .ripple::after {
            content: '';
            position: absolute;
            inset: -10px;
            border: 3px solid currentColor;
            border-radius: 50%;
            animation: ripple 1.5s ease-out infinite;
        }
        .ripple::after { animation-delay: 0.5s; }
        
        /* Button hover */
        .btn-hover { transition: all 0.2s ease; }
        .btn-hover:hover { transform: translateY(-1px); }
        
        /* Search dropdown */
        .search-dropdown { max-height: 400px; overflow-y: auto; }
        
        /* Active nav */
        .nav-active { color: #2563eb; border-bottom: 3px solid #2563eb; }
        .dark .nav-active { color: #3b82f6; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-dark-100 transition-colors duration-200">

<!-- ==================== AUTH PAGE ==================== -->
<div id="authPage" class="min-h-screen flex items-center justify-center p-4 bg-gradient-to-br from-blue-500 via-blue-600 to-purple-700">
    <div class="w-full max-w-5xl flex flex-col lg:flex-row bg-white dark:bg-dark-200 rounded-2xl shadow-2xl overflow-hidden fade-in">
        <!-- Left Side -->
        <div class="lg:w-1/2 p-8 lg:p-12 bg-gradient-to-br from-blue-600 to-purple-700 text-white flex flex-col justify-center">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur">
                    <i class="fab fa-facebook text-2xl"></i>
                </div>
                <h1 class="text-3xl font-bold">SocialBook</h1>
            </div>
            <p class="text-lg text-white/90 mb-8">Kapcsolódj a barátaiddal és a világgal a SocialBook-on.</p>
            <div class="space-y-4 hidden lg:block">
                <div class="flex items-center gap-4 bg-white/10 rounded-xl p-4 backdrop-blur">
                    <i class="fas fa-users text-2xl"></i>
                    <div>
                        <p class="font-semibold">Ismerősök</p>
                        <p class="text-sm text-white/70">Tartsd a kapcsolatot barátaiddal</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 bg-white/10 rounded-xl p-4 backdrop-blur">
                    <i class="fas fa-comments text-2xl"></i>
                    <div>
                        <p class="font-semibold">Messenger</p>
                        <p class="text-sm text-white/70">Chatelj és hívd fel barátaidat</p>
                    </div>
                </div>
                <div class="flex items-center gap-4 bg-white/10 rounded-xl p-4 backdrop-blur">
                    <i class="fas fa-photo-video text-2xl"></i>
                    <div>
                        <p class="font-semibold">Történetek</p>
                        <p class="text-sm text-white/70">Oszd meg a pillanataidat</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Side - Forms -->
        <div class="lg:w-1/2 p-8 lg:p-12">
            <!-- Login Form -->
            <div id="loginForm">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Bejelentkezés</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-6">Üdv újra! Jelentkezz be a fiókodba.</p>
                
                <div class="space-y-4">
                    <div>
                        <input type="email" id="loginEmail" placeholder="Email cím" 
                            class="w-full px-4 py-3 bg-gray-100 dark:bg-dark-300 rounded-xl text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-dark-400 transition outline-none">
                    </div>
                    <div>
                        <input type="password" id="loginPassword" placeholder="Jelszó" 
                            class="w-full px-4 py-3 bg-gray-100 dark:bg-dark-300 rounded-xl text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 focus:bg-white dark:focus:bg-dark-400 transition outline-none"
                            onkeypress="if(event.key==='Enter')login()">
                    </div>
                    <button onclick="login()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-semibold transition btn-hover">
                        Bejelentkezés
                    </button>
                </div>
                
                <div class="mt-6 pt-6 border-t border-gray-200 dark:border-dark-300 text-center">
                    <p class="text-gray-500 dark:text-gray-400 mb-4">Nincs még fiókod?</p>
                    <button onclick="showRegister()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition btn-hover">
                        Új fiók létrehozása
                    </button>
                </div>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">Regisztráció</h2>
                <p class="text-gray-500 dark:text-gray-400 mb-6">Hozd létre a fiókodat pillanatok alatt.</p>
                
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <input type="text" id="regFirstName" placeholder="Keresztnév" 
                            class="w-1/2 px-4 py-3 bg-gray-100 dark:bg-dark-300 rounded-xl text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 transition outline-none">
                        <input type="text" id="regLastName" placeholder="Vezetéknév" 
                            class="w-1/2 px-4 py-3 bg-gray-100 dark:bg-dark-300 rounded-xl text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 transition outline-none">
                    </div>
                    <div class="relative">
                        <div class="flex items-center bg-gray-100 dark:bg-dark-300 rounded-xl border-2 border-transparent focus-within:border-blue-500 transition">
                            <span class="pl-4 text-gray-500">@</span>
                            <input type="text" id="regUsername" placeholder="felhasznalonev" 
                                class="flex-1 px-2 py-3 bg-transparent text-gray-800 dark:text-white outline-none"
                                oninput="checkUsername(this.value)">
                        </div>
                        <div id="usernameStatus" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                            <i class="fas fa-check text-green-500"></i>
                        </div>
                        <p id="usernameHint" class="text-xs text-gray-500 mt-1 ml-1">Csak betűk, számok, pont és aláhúzás</p>
                    </div>
                    <div>
                        <input type="email" id="regEmail" placeholder="Email cím" 
                            class="w-full px-4 py-3 bg-gray-100 dark:bg-dark-300 rounded-xl text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 transition outline-none">
                    </div>
                    <div>
                        <input type="password" id="regPassword" placeholder="Jelszó (min. 6 karakter)" 
                            class="w-full px-4 py-3 bg-gray-100 dark:bg-dark-300 rounded-xl text-gray-800 dark:text-white border-2 border-transparent focus:border-blue-500 transition outline-none"
                            onkeypress="if(event.key==='Enter')register()">
                    </div>
                    <button onclick="register()" class="w-full bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-semibold transition btn-hover">
                        Regisztráció
                    </button>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="showLogin()" class="text-blue-600 hover:underline font-medium">
                        Vissza a bejelentkezéshez
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ==================== MAIN APP ==================== -->
<div id="mainApp" class="hidden">
    
    <!-- Navbar -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-white dark:bg-dark-200 shadow-sm">
        <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
            <!-- Logo & Search -->
            <div class="flex items-center gap-2">
                <div onclick="navigate('feed')" class="w-10 h-10 bg-blue-600 rounded-full flex items-center justify-center cursor-pointer hover:bg-blue-700 transition">
                    <i class="fab fa-facebook-f text-white text-xl"></i>
                </div>
                
                <!-- Search -->
                <div class="relative">
                    <div class="flex items-center bg-gray-100 dark:bg-dark-300 rounded-full">
                        <i class="fas fa-search text-gray-500 pl-3"></i>
                        <input type="text" id="searchInput" placeholder="Keresés a SocialBookon" 
                            class="bg-transparent px-3 py-2 w-48 lg:w-64 text-gray-800 dark:text-white outline-none text-sm"
                            oninput="handleSearch(this.value)"
                            onfocus="showSearchDropdown()"
                            onblur="setTimeout(() => hideSearchDropdown(), 200)">
                    </div>
                    <!-- Search Results -->
                    <div id="searchDropdown" class="hidden absolute top-12 left-0 w-80 bg-white dark:bg-dark-200 rounded-xl shadow-2xl border border-gray-200 dark:border-dark-300 search-dropdown slide-up">
                        <div class="p-3 border-b border-gray-100 dark:border-dark-300">
                            <h3 class="font-semibold text-gray-800 dark:text-white text-sm">Keresési eredmények</h3>
                        </div>
                        <div id="searchResults" class="p-2"></div>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <div class="hidden md:flex items-center gap-2">
                <button onclick="navigate('feed')" id="navFeed" class="nav-btn px-8 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition" title="Főoldal">
                    <i class="fas fa-home text-xl text-gray-500 dark:text-gray-400"></i>
                </button>
                <button onclick="navigate('friends')" id="navFriends" class="nav-btn px-8 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition" title="Barátok">
                    <i class="fas fa-user-friends text-xl text-gray-500 dark:text-gray-400"></i>
                </button>
                <button onclick="navigate('messenger')" id="navMessenger" class="nav-btn px-8 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition relative" title="Messenger">
                    <i class="fab fa-facebook-messenger text-xl text-gray-500 dark:text-gray-400"></i>
                </button>
                <button onclick="navigate('notifications')" id="navNotifications" class="nav-btn px-8 py-3 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition relative" title="Értesítések">
                    <i class="fas fa-bell text-xl text-gray-500 dark:text-gray-400"></i>
                    <span id="notifBadge" class="hidden absolute top-1 right-4 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
                </button>
            </div>
            
            <!-- User Menu -->
            <div class="flex items-center gap-2">
                <button id="msgBadgeBtn" onclick="navigate('messenger')" class="md:hidden w-10 h-10 bg-gray-200 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-dark-400 transition relative">
                    <i class="fab fa-facebook-messenger text-gray-700 dark:text-gray-300"></i>
                    <span id="msgBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">0</span>
                </button>
                
                <button onclick="toggleDarkMode()" class="w-10 h-10 bg-gray-200 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-dark-400 transition">
                    <i id="themeIcon" class="fas fa-moon text-gray-700 dark:text-gray-300"></i>
                </button>
                
                <div class="relative">
                    <button onclick="toggleUserMenu()" class="flex items-center gap-2 hover:bg-gray-100 dark:hover:bg-dark-300 rounded-full p-1 transition">
                        <img id="navAvatar" src="" class="w-9 h-9 rounded-full object-cover">
                    </button>
                    
                    <!-- User Dropdown -->
                    <div id="userMenu" class="hidden absolute right-0 top-12 w-72 bg-white dark:bg-dark-200 rounded-xl shadow-2xl border border-gray-200 dark:border-dark-300 slide-up">
                        <div class="p-2">
                            <div onclick="navigate('profile', currentUser._id)" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 cursor-pointer transition">
                                <img id="menuAvatar" src="" class="w-10 h-10 rounded-full">
                                <div>
                                    <p id="menuName" class="font-semibold text-gray-800 dark:text-white"></p>
                                    <p class="text-xs text-gray-500">Profil megtekintése</p>
                                </div>
                            </div>
                        </div>
                        <hr class="border-gray-200 dark:border-dark-300">
                        <div class="p-2">
                            <div id="adminMenuItem" class="hidden">
                                <button onclick="navigate('admin')" class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-left">
                                    <div class="w-9 h-9 bg-purple-100 dark:bg-purple-900/30 rounded-full flex items-center justify-center">
                                        <i class="fas fa-shield-alt text-purple-600"></i>
                                    </div>
                                    <span class="text-gray-700 dark:text-gray-300 font-medium">Admin Panel</span>
                                </button>
                            </div>
                            <button onclick="showSettings()" class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-left">
                                <div class="w-9 h-9 bg-gray-200 dark:bg-dark-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-cog text-gray-600 dark:text-gray-400"></i>
                                </div>
                                <span class="text-gray-700 dark:text-gray-300 font-medium">Beállítások</span>
                            </button>
                            <button onclick="logout()" class="w-full flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-left">
                                <div class="w-9 h-9 bg-gray-200 dark:bg-dark-300 rounded-full flex items-center justify-center">
                                    <i class="fas fa-sign-out-alt text-gray-600 dark:text-gray-400"></i>
                                </div>
                                <span class="text-gray-700 dark:text-gray-300 font-medium">Kijelentkezés</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Right Sidebar - Friends List (Fixed) -->
    <aside id="rightSidebar" class="fixed right-0 top-14 w-72 h-[calc(100vh-3.5rem)] bg-white dark:bg-dark-200 border-l border-gray-200 dark:border-dark-300 hidden lg:block overflow-y-auto z-30">
        <div class="p-4">
            <!-- Csoportok -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-500 dark:text-gray-400 text-sm">Csoportos beszélgetések</h3>
                    <button onclick="openCreateGroupModal()" class="w-7 h-7 bg-gray-100 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-400 transition" title="Új csoport">
                        <i class="fas fa-plus text-gray-600 dark:text-gray-400 text-xs"></i>
                    </button>
                </div>
                <div id="sidebarGroups" class="space-y-1"></div>
            </div>
            
            <!-- Online barátok -->
            <div class="mb-4">
                <h3 class="font-semibold text-gray-500 dark:text-gray-400 text-sm mb-3">Online barátok</h3>
                <div id="sidebarOnlineFriends" class="space-y-1"></div>
            </div>
            
            <!-- Összes barát -->
            <div>
                <h3 class="font-semibold text-gray-500 dark:text-gray-400 text-sm mb-3">Összes barát</h3>
                <div id="sidebarAllFriends" class="space-y-1"></div>
            </div>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="pt-14 min-h-screen lg:mr-72">
        
        <!-- ========== FEED PAGE ========== -->
        <div id="feedPage" class="hidden">
            <div class="max-w-xl mx-auto px-4 py-4">
                <!-- Stories -->
                <div class="bg-white dark:bg-dark-200 rounded-xl p-4 mb-4 shadow">
                    <div id="storiesContainer" class="flex gap-3 overflow-x-auto pb-2"></div>
                </div>
                
                <!-- Create Post -->
                <div class="bg-white dark:bg-dark-200 rounded-xl p-4 mb-4 shadow">
                    <div class="flex items-center gap-3">
                        <img id="feedAvatar" src="" class="w-10 h-10 rounded-full">
                        <button onclick="openPostModal()" class="flex-1 bg-gray-100 dark:bg-dark-300 rounded-full px-4 py-2.5 text-left text-gray-500 hover:bg-gray-200 dark:hover:bg-dark-400 transition">
                            Mi jár a fejedben?
                        </button>
                    </div>
                    <hr class="my-3 border-gray-200 dark:border-dark-300">
                    <div class="flex">
                        <button onclick="openPostModal()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-gray-600 dark:text-gray-400">
                            <i class="fas fa-video text-red-500"></i>
                            <span class="font-medium text-sm">Élő videó</span>
                        </button>
                        <button onclick="openPostModal()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-gray-600 dark:text-gray-400">
                            <i class="fas fa-image text-green-500"></i>
                            <span class="font-medium text-sm">Fotó/videó</span>
                        </button>
                        <button onclick="openPostModal()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-gray-600 dark:text-gray-400">
                            <i class="fas fa-smile text-yellow-500"></i>
                            <span class="font-medium text-sm">Érzés</span>
                        </button>
                    </div>
                </div>
                
                <!-- Posts -->
                <div id="postsContainer" class="space-y-4"></div>
            </div>
        </div>
        
        <!-- ========== MESSENGER PAGE ========== -->
        <div id="messengerPage" class="hidden h-[calc(100vh-3.5rem)]">
            <div class="h-full flex">
                <!-- Chat List -->
                <div class="w-80 bg-white dark:bg-dark-200 border-r border-gray-200 dark:border-dark-300 flex flex-col">
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-4">
                            <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Csevegések</h1>
                            <button class="w-9 h-9 bg-gray-100 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-400 transition">
                                <i class="fas fa-edit text-gray-600 dark:text-gray-400"></i>
                            </button>
                        </div>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            <input type="text" id="messengerSearch" placeholder="Keresés a Messengerben" 
                                class="w-full bg-gray-100 dark:bg-dark-300 rounded-full pl-10 pr-4 py-2 text-sm outline-none text-gray-800 dark:text-white"
                                oninput="filterChatList(this.value)">
                        </div>
                    </div>
                    <div id="messengerChatList" class="flex-1 overflow-y-auto px-2"></div>
                </div>
                
                <!-- Chat Area -->
                <div id="messengerChatArea" class="flex-1 flex flex-col bg-white dark:bg-dark-200">
                    <div id="messengerWelcome" class="flex-1 flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-20 h-20 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fab fa-facebook-messenger text-white text-3xl"></i>
                            </div>
                            <h2 class="text-xl font-semibold text-gray-700 dark:text-gray-300">Üzeneteid</h2>
                            <p class="text-gray-500 text-sm mt-1">Küldj privát üzeneteket egy barátodnak</p>
                        </div>
                    </div>
                    <div id="messengerActiveChat" class="hidden flex-1 flex flex-col">
                        <!-- Chat Header -->
                        <div id="messengerChatHeader" class="h-16 border-b border-gray-200 dark:border-dark-300 flex items-center justify-between px-4"></div>
                        <!-- Messages -->
                        <div id="messengerMessages" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
                        <!-- Typing -->
                        <div id="messengerTyping" class="hidden px-4 py-2">
                            <div class="flex items-center gap-2 text-gray-500 text-sm">
                                <div class="flex gap-1">
                                    <span class="typing-dot"></span>
                                    <span class="typing-dot"></span>
                                    <span class="typing-dot"></span>
                                </div>
                                <span>Gépel...</span>
                            </div>
                        </div>
                        <!-- Input -->
                        <div class="p-4 border-t border-gray-200 dark:border-dark-300">
                            <div class="flex items-center gap-2">
                                <button class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition">
                                    <i class="fas fa-plus-circle text-xl"></i>
                                </button>
                                <button class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition">
                                    <i class="fas fa-image text-xl"></i>
                                </button>
                                <div class="flex-1 relative">
                                    <input type="text" id="messengerInput" placeholder="Aa" 
                                        class="w-full bg-gray-100 dark:bg-dark-300 rounded-full px-4 py-2 pr-10 outline-none text-gray-800 dark:text-white"
                                        oninput="handleMessengerTyping()"
                                        onkeypress="if(event.key==='Enter')sendMessengerMessage()">
                                    <button class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-500">
                                        <i class="far fa-smile"></i>
                                    </button>
                                </div>
                                <button onclick="sendMessengerMessage()" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition">
                                    <i class="fas fa-paper-plane text-xl"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== FRIENDS PAGE ========== -->
        <div id="friendsPage" class="hidden">
            <div class="max-w-4xl mx-auto px-4 py-6">
                <div class="bg-white dark:bg-dark-200 rounded-xl shadow">
                    <div class="p-6 border-b border-gray-200 dark:border-dark-300">
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Barátok</h1>
                    </div>
                    <div class="p-4 border-b border-gray-200 dark:border-dark-300">
                        <div class="flex gap-2 flex-wrap">
                            <button onclick="showFriendsTab('all')" class="friends-tab px-4 py-2 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 font-medium text-sm transition">Összes barát</button>
                            <button onclick="showFriendsTab('requests')" class="friends-tab px-4 py-2 rounded-full bg-gray-100 dark:bg-dark-300 text-gray-700 dark:text-gray-300 font-medium text-sm hover:bg-gray-200 dark:hover:bg-dark-400 transition">Barátkérelmek</button>
                            <button onclick="showFriendsTab('suggestions')" class="friends-tab px-4 py-2 rounded-full bg-gray-100 dark:bg-dark-300 text-gray-700 dark:text-gray-300 font-medium text-sm hover:bg-gray-200 dark:hover:bg-dark-400 transition">Ismerősök</button>
                        </div>
                    </div>
                    <div id="friendsContent" class="p-6"></div>
                </div>
            </div>
        </div>
        
        <!-- ========== PROFILE PAGE ========== -->
        <div id="profilePage" class="hidden">
            <div class="bg-white dark:bg-dark-200 shadow">
                <div class="max-w-4xl mx-auto">
                    <!-- Cover -->
                    <div class="h-64 md:h-80 bg-gradient-to-r from-gray-300 to-gray-400 dark:from-dark-300 dark:to-dark-400 relative rounded-b-lg overflow-hidden">
                        <img id="profileCover" src="" class="w-full h-full object-cover">
                    </div>
                    <!-- Profile Info -->
                    <div class="px-6 pb-4 relative">
                        <div class="absolute -top-16 left-6">
                            <img id="profileAvatar" src="" class="w-32 h-32 md:w-40 md:h-40 rounded-full border-4 border-white dark:border-dark-200 object-cover shadow-lg">
                        </div>
                        <div class="ml-36 md:ml-48 pt-4 flex flex-col md:flex-row md:items-end justify-between gap-4">
                            <div>
                                <h1 id="profileName" class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white inline-flex items-center flex-wrap gap-2"></h1>
                                <p id="profileUsername" class="text-blue-500 hover:underline cursor-pointer text-sm font-medium mt-1">@username</p>
                                <p id="profileFriendCount" class="text-gray-500 font-medium mt-1"></p>
                            </div>
                            <div id="profileActions" class="flex gap-2 flex-wrap"></div>
                        </div>
                        <p id="profileBio" class="mt-4 text-gray-600 dark:text-gray-400 md:ml-48"></p>
                    </div>
                </div>
            </div>
            
            <div class="max-w-4xl mx-auto px-4 py-6">
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- Bal oldali info panel -->
                    <div class="md:w-80 flex-shrink-0">
                        <div id="profileInfoCard" class="bg-white dark:bg-dark-200 rounded-xl shadow p-4 sticky top-20">
                            <h3 class="font-bold text-gray-800 dark:text-white text-lg mb-4">Bemutatkozás</h3>
                            <div id="profileInfoContent" class="space-y-3 text-sm"></div>
                        </div>
                    </div>
                    
                    <!-- Jobb oldali posztok -->
                    <div class="flex-1">
                        <div id="profilePosts" class="space-y-4"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ========== NOTIFICATIONS PAGE ========== -->
        <div id="notificationsPage" class="hidden">
            <div class="max-w-2xl mx-auto px-4 py-6">
                <div class="bg-white dark:bg-dark-200 rounded-xl shadow">
                    <div class="p-6 border-b border-gray-200 dark:border-dark-300">
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Értesítések</h1>
                    </div>
                    <div id="notificationsList" class="divide-y divide-gray-100 dark:divide-dark-300"></div>
                </div>
            </div>
        </div>
        
        <!-- ========== ADMIN PAGE ========== -->
        <div id="adminPage" class="hidden">
            <div class="max-w-5xl mx-auto px-4 py-6">
                <div class="bg-white dark:bg-dark-200 rounded-xl shadow">
                    <div class="p-6 border-b border-gray-200 dark:border-dark-300">
                        <h1 class="text-2xl font-bold text-gray-800 dark:text-white flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-lg flex items-center justify-center">
                                <i class="fas fa-shield-alt text-white"></i>
                            </div>
                            Admin Panel
                        </h1>
                    </div>
                    <div class="p-6">
                        <!-- Stats -->
                        <div class="grid md:grid-cols-3 gap-4 mb-8">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm">Felhasználók</p>
                                        <p id="adminUsers" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <i class="fas fa-users text-3xl text-blue-200"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-5 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm">Posztok</p>
                                        <p id="adminPosts" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <i class="fas fa-newspaper text-3xl text-green-200"></i>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-5 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100 text-sm">Üzenetek</p>
                                        <p id="adminMessages" class="text-3xl font-bold mt-1">0</p>
                                    </div>
                                    <i class="fas fa-comments text-3xl text-purple-200"></i>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Users List -->
                        <h2 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">Felhasználók kezelése</h2>
                        <div id="adminUserList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
        
    </main>
    
    <!-- ========== FLOATING CHAT WINDOWS ========== -->
    <div id="chatWindowsContainer" class="fixed bottom-0 right-4 flex items-end gap-2 z-40"></div>
    
</div>

<!-- ==================== MODALS ==================== -->

<!-- Post Modal -->
<div id="postModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-200 rounded-xl w-full max-w-lg shadow-2xl slide-up">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-dark-300">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Bejegyzés létrehozása</h3>
            <button onclick="closePostModal()" class="w-9 h-9 bg-gray-100 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-400 transition">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="p-4">
            <div class="flex items-center gap-3 mb-4">
                <img id="postModalAvatar" src="" class="w-10 h-10 rounded-full">
                <div>
                    <p id="postModalName" class="font-semibold text-gray-800 dark:text-white text-sm"></p>
                    <p class="text-xs text-gray-500"><i class="fas fa-globe-americas mr-1"></i>Nyilvános</p>
                </div>
            </div>
            <textarea id="postContent" rows="4" placeholder="Mi jár a fejedben?" 
                class="w-full bg-transparent text-gray-800 dark:text-white text-lg resize-none outline-none placeholder-gray-400"></textarea>
            <div id="postImagePreview" class="hidden mt-4 relative">
                <img id="postPreviewImg" src="" class="max-h-64 w-full object-cover rounded-lg">
                <button onclick="removePostImage()" class="absolute top-2 right-2 w-8 h-8 bg-black/60 rounded-full flex items-center justify-center text-white hover:bg-black/80 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div class="px-4 pb-4">
            <div class="flex items-center justify-between p-3 border border-gray-200 dark:border-dark-300 rounded-lg mb-4">
                <span class="text-gray-700 dark:text-gray-300 font-medium text-sm">Hozzáadás a bejegyzéshez</span>
                <div class="flex gap-1">
                    <label class="w-9 h-9 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-dark-300 rounded-full cursor-pointer transition">
                        <i class="fas fa-image text-green-500"></i>
                        <input type="file" id="postImageInput" accept="image/*" class="hidden" onchange="previewPostImage(this)">
                    </label>
                    <button class="w-9 h-9 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-dark-300 rounded-full transition">
                        <i class="fas fa-user-tag text-blue-500"></i>
                    </button>
                    <button class="w-9 h-9 flex items-center justify-center hover:bg-gray-100 dark:hover:bg-dark-300 rounded-full transition">
                        <i class="fas fa-smile text-yellow-500"></i>
                    </button>
                </div>
            </div>
            <button onclick="createPost()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-semibold transition">
                Közzététel
            </button>
        </div>
    </div>
</div>

<!-- Story Modal -->
<div id="storyModal" class="hidden fixed inset-0 bg-black z-50 flex items-center justify-center">
    <button onclick="closeStoryModal()" class="absolute top-4 right-4 w-10 h-10 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center transition z-10">
        <i class="fas fa-times text-white text-xl"></i>
    </button>
    
    <!-- Create Story -->
    <div id="storyCreate" class="max-w-md w-full mx-4">
        <h3 class="text-xl font-bold text-white mb-4 text-center">Történet létrehozása</h3>
        <div class="bg-dark-200 rounded-xl p-6">
            <div id="storyPreview" class="hidden mb-4 relative">
                <img id="storyPreviewImg" src="" class="max-h-80 w-full object-cover rounded-lg">
                <button onclick="removeStoryImage()" class="absolute top-2 right-2 w-8 h-8 bg-black/60 rounded-full flex items-center justify-center text-white">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <label id="storyUploadLabel" class="block w-full p-10 border-2 border-dashed border-gray-500 rounded-xl text-center cursor-pointer hover:border-blue-500 transition">
                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-400">Kattints a kép feltöltéséhez</p>
                <input type="file" id="storyImageInput" accept="image/*" class="hidden" onchange="previewStoryImage(this)">
            </label>
            <button onclick="createStory()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold mt-4 transition">
                Megosztás
            </button>
        </div>
    </div>
    
    <!-- View Story -->
    <div id="storyView" class="hidden max-w-md w-full mx-4">
        <div class="relative">
            <div class="absolute top-4 left-4 right-4 flex items-center gap-3 z-10">
                <img id="storyViewAvatar" src="" class="w-10 h-10 rounded-full ring-2 ring-white">
                <div class="flex-1">
                    <p id="storyViewName" class="text-white font-semibold text-sm"></p>
                    <p id="storyViewTime" class="text-white/70 text-xs"></p>
                </div>
                <button id="storyDeleteBtn" onclick="deleteStory()" class="hidden w-9 h-9 bg-white/10 hover:bg-red-500/50 rounded-full flex items-center justify-center transition">
                    <i class="fas fa-trash text-white"></i>
                </button>
            </div>
            <img id="storyViewImg" src="" class="max-h-[80vh] w-full object-contain rounded-xl">
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-200 rounded-xl w-full max-w-lg shadow-2xl slide-up max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-dark-300 sticky top-0 bg-white dark:bg-dark-200">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Beállítások</h3>
            <button onclick="closeSettings()" class="w-9 h-9 bg-gray-100 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-400 transition">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <!-- Alapadatok -->
            <h4 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2">
                <i class="fas fa-user text-blue-500"></i> Alapadatok
            </h4>
            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Keresztnév *</label>
                    <input type="text" id="settingsFirstName" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vezetéknév <span id="lastNameRequired">*</span></label>
                    <input type="text" id="settingsLastName" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Felhasználónév</label>
                <div class="flex gap-2">
                    <div class="flex-1 flex items-center bg-gray-100 dark:bg-dark-300 rounded-lg px-4 py-2.5 border-2 border-transparent focus-within:border-blue-500">
                        <span class="text-gray-500 mr-1">@</span>
                        <input type="text" id="settingsUsername" class="flex-1 bg-transparent text-gray-800 dark:text-white outline-none"
                            oninput="checkNewUsername(this.value)">
                    </div>
                </div>
                <p id="usernameChangeHint" class="text-xs text-gray-500 mt-1"></p>
            </div>
            
            <!-- Profilképek -->
            <h4 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2 pt-2">
                <i class="fas fa-image text-green-500"></i> Profilképek
            </h4>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Profilkép URL</label>
                <input type="text" id="settingsAvatar" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/kep.jpg">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Borítókép URL</label>
                <input type="text" id="settingsCover" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://example.com/borito.jpg">
            </div>
            
            <!-- Bemutatkozás -->
            <h4 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2 pt-2">
                <i class="fas fa-info-circle text-purple-500"></i> Bemutatkozás
            </h4>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Rövid bemutatkozás</label>
                <textarea id="settingsBio" rows="2" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500 resize-none" placeholder="Írj magadról pár szót..."></textarea>
            </div>
            
            <!-- Munka és tanulmányok -->
            <h4 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2 pt-2">
                <i class="fas fa-briefcase text-orange-500"></i> Munka és tanulmányok
            </h4>
            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Munkahely</label>
                    <input type="text" id="settingsWorkplace" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Cég neve">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Munkakör</label>
                    <input type="text" id="settingsJobTitle" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Pozíció">
                </div>
            </div>
            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Középiskola</label>
                    <input type="text" id="settingsSchool" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Iskola neve">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Egyetem/Főiskola</label>
                    <input type="text" id="settingsCollege" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Egyetem neve">
                </div>
            </div>
            
            <!-- Lakóhely -->
            <h4 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2 pt-2">
                <i class="fas fa-map-marker-alt text-red-500"></i> Lakóhely
            </h4>
            <div class="flex gap-3">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Jelenlegi város</label>
                    <input type="text" id="settingsCurrentCity" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Budapest">
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Szülőváros</label>
                    <input type="text" id="settingsHometown" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500" placeholder="Debrecen">
                </div>
            </div>
            
            <!-- Kapcsolati állapot -->
            <h4 class="font-semibold text-gray-800 dark:text-white flex items-center gap-2 pt-2">
                <i class="fas fa-heart text-pink-500"></i> Kapcsolati állapot
            </h4>
            <div>
                <select id="settingsRelationship" class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Nincs megadva</option>
                    <option value="single">Egyedülálló</option>
                    <option value="in_relationship">Kapcsolatban</option>
                    <option value="engaged">Jegyben</option>
                    <option value="married">Házas</option>
                    <option value="complicated">Bonyolult</option>
                </select>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-dark-300 sticky bottom-0 bg-white dark:bg-dark-200">
            <button onclick="saveSettings()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-semibold transition">
                Mentés
            </button>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
<div id="createGroupModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-200 rounded-xl w-full max-w-md shadow-2xl slide-up">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-dark-300">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Új csoport létrehozása</h3>
            <button onclick="closeCreateGroupModal()" class="w-9 h-9 bg-gray-100 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-400 transition">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div class="p-4 space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Csoport neve *</label>
                <input type="text" id="groupName" placeholder="pl. Barátok, Család, Munka..." 
                    class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Csoport kép URL (opcionális)</label>
                <input type="text" id="groupImage" placeholder="https://example.com/kep.jpg" 
                    class="w-full px-4 py-2.5 bg-gray-100 dark:bg-dark-300 rounded-lg text-gray-800 dark:text-white outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tagok kiválasztása *</label>
                <div id="groupMembersList" class="max-h-48 overflow-y-auto space-y-2 bg-gray-50 dark:bg-dark-300 rounded-lg p-2"></div>
            </div>
            <div id="selectedMembers" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-dark-300">
            <button onclick="createGroup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2.5 rounded-lg font-semibold transition">
                Csoport létrehozása
            </button>
        </div>
    </div>
</div>

<!-- Group Chat Modal -->
<div id="groupChatModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-200 rounded-xl w-full max-w-2xl h-[80vh] shadow-2xl slide-up flex flex-col">
        <div id="groupChatHeader" class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-dark-300">
            <!-- Header content will be injected -->
        </div>
        <div id="groupChatMessages" class="flex-1 overflow-y-auto p-4 space-y-3"></div>
        <div id="groupChatTyping" class="hidden px-4 py-2">
            <div class="flex items-center gap-2 text-gray-500 text-sm">
                <div class="flex gap-1">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
                <span id="groupTypingText">Valaki gépel...</span>
            </div>
        </div>
        <div class="p-4 border-t border-gray-200 dark:border-dark-300">
            <div class="flex items-center gap-2">
                <button class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition">
                    <i class="fas fa-image text-xl"></i>
                </button>
                <div class="flex-1 relative">
                    <input type="text" id="groupChatInput" placeholder="Írj üzenetet..." 
                        class="w-full bg-gray-100 dark:bg-dark-300 rounded-full px-4 py-2 pr-10 outline-none text-gray-800 dark:text-white"
                        oninput="handleGroupTyping()"
                        onkeypress="if(event.key==='Enter')sendGroupMessage()">
                    <button class="absolute right-3 top-1/2 -translate-y-1/2 text-blue-500">
                        <i class="far fa-smile"></i>
                    </button>
                </div>
                <button onclick="sendGroupMessage()" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition">
                    <i class="fas fa-paper-plane text-xl"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Group Info Modal -->
<div id="groupInfoModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
    <div class="bg-white dark:bg-dark-200 rounded-xl w-full max-w-md shadow-2xl slide-up max-h-[80vh] overflow-y-auto">
        <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-dark-300 sticky top-0 bg-white dark:bg-dark-200">
            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Csoport beállításai</h3>
            <button onclick="closeGroupInfoModal()" class="w-9 h-9 bg-gray-100 dark:bg-dark-300 rounded-full flex items-center justify-center hover:bg-gray-200 dark:hover:bg-dark-400 transition">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        <div id="groupInfoContent" class="p-4"></div>
    </div>
</div>

<!-- Call Modal -->
<div id="callModal" class="hidden fixed inset-0 z-50 flex items-center justify-center" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);">
    <div class="text-center slide-up">
        <div class="relative inline-block mb-6">
            <div class="ripple absolute inset-0 text-blue-400"></div>
            <img id="callAvatar" src="" class="w-32 h-32 rounded-full object-cover ring-4 ring-white/20 relative z-10">
        </div>
        <h3 id="callName" class="text-2xl font-bold text-white mb-2"></h3>
        <p id="callStatus" class="text-gray-300 mb-8">Hívás...</p>
        
        <div id="callControls" class="hidden mb-6">
            <div class="flex justify-center gap-4">
                <button onclick="toggleMute()" id="muteBtn" class="w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition">
                    <i class="fas fa-microphone"></i>
                </button>
                <button onclick="toggleVideo()" id="videoBtn" class="w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition">
                    <i class="fas fa-video"></i>
                </button>
                <button class="w-12 h-12 bg-white/10 hover:bg-white/20 rounded-full flex items-center justify-center text-white transition">
                    <i class="fas fa-volume-up"></i>
                </button>
            </div>
        </div>
        
        <div class="flex justify-center gap-6">
            <button onclick="endCall()" class="w-16 h-16 bg-red-500 hover:bg-red-600 rounded-full flex items-center justify-center text-white transition shadow-lg">
                <i class="fas fa-phone-slash text-2xl"></i>
            </button>
            <button id="acceptCallBtn" onclick="acceptCall()" class="hidden w-16 h-16 bg-green-500 hover:bg-green-600 rounded-full flex items-center justify-center text-white transition shadow-lg">
                <i class="fas fa-phone text-2xl"></i>
            </button>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="fixed bottom-4 left-4 z-50 space-y-2"></div>

<!-- ==================== JAVASCRIPT ==================== -->
<script>
// ============ GLOBALS ============
let socket;
let currentUser = null;
let token = localStorage.getItem('token');
let allUsers = [];
let allGroups = [];
let openChats = new Map();
let openGroupChats = new Map();
let currentMessengerChat = null;
let currentGroupChat = null;
let currentStory = null;
let callState = { active: false, muted: false, videoOff: false, userId: null };
let selectedGroupMembers = new Set();

const API = window.location.origin + '/api';

// ============ UTILITIES ============
function toast(message, type = 'info') {
    const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
    const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
    const div = document.createElement('div');
    div.className = `${colors[type]} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 slide-up`;
    div.innerHTML = `<i class="fas fa-${icons[type]}"></i><span>${message}</span>`;
    document.getElementById('toastContainer').appendChild(div);
    setTimeout(() => div.remove(), 3000);
}

function timeAgo(date) {
    const seconds = Math.floor((Date.now() - new Date(date)) / 1000);
    if (seconds < 60) return 'Most';
    if (seconds < 3600) return `${Math.floor(seconds / 60)} perce`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)} órája`;
    return `${Math.floor(seconds / 86400)} napja`;
}

async function api(endpoint, options = {}) {
    try {
        const res = await fetch(API + endpoint, {
            ...options,
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : '',
                ...options.headers
            }
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'Hiba történt');
        return data;
    } catch (err) {
        toast(err.message, 'error');
        throw err;
    }
}

function getAvatar(user) {
    const name = user?.name || user?.firstName || 'U';
    return user?.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=random&size=200`;
}

function getUserName(user) {
    if (!user) return 'Ismeretlen';
    if (user.name) return user.name;
    if (user.firstName || user.lastName) {
        return `${user.firstName || ''} ${user.lastName || ''}`.trim();
    }
    return user.username || 'Ismeretlen';
}

function getUserBadge(user, size = 'sm') {
    if (!user) return '';
    const sizeClass = size === 'lg' ? 'text-xs px-2 py-1' : 'text-[10px] px-1.5 py-0.5';
    if (user.isOwner) {
        return `<span class="inline-flex items-center gap-1 ${sizeClass} bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-full font-semibold ml-1">
            <i class="fas fa-crown text-[8px]"></i>Tulajdonos
        </span>`;
    }
    if (user.isAdmin) {
        return `<span class="inline-flex items-center gap-1 ${sizeClass} bg-gradient-to-r from-purple-500 to-indigo-500 text-white rounded-full font-semibold ml-1">
            <i class="fas fa-shield-alt text-[8px]"></i>Admin
        </span>`;
    }
    return '';
}

// Kép feltöltése ImgBB-re (ingyenes, korlátlan tárhely)
async function uploadImage(base64Image) {
    try {
        const result = await api('/upload', {
            method: 'POST',
            body: JSON.stringify({ image: base64Image })
        });
        return result.url;
    } catch (error) {
        console.error('Képfeltöltés hiba:', error);
        // Fallback: eredeti base64 visszaadása
        return base64Image;
    }
}

// ============ AUTH ============
function showLogin() {
    document.getElementById('loginForm').classList.remove('hidden');
    document.getElementById('registerForm').classList.add('hidden');
}

function showRegister() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('registerForm').classList.remove('hidden');
}

async function login() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    if (!email || !password) return toast('Töltsd ki az összes mezőt!', 'error');
    
    try {
        const data = await api('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ email, password })
        });
        token = data.token;
        currentUser = data.user;
        localStorage.setItem('token', token);
        initApp();
        toast('Sikeres bejelentkezés!', 'success');
    } catch (e) {}
}

let usernameAvailable = false;
let usernameCheckTimeout;

async function checkUsername(username) {
    const statusEl = document.getElementById('usernameStatus');
    const hintEl = document.getElementById('usernameHint');
    
    clearTimeout(usernameCheckTimeout);
    
    if (!username || username.length < 3) {
        statusEl.classList.add('hidden');
        hintEl.textContent = 'Minimum 3 karakter szükséges';
        hintEl.className = 'text-xs text-gray-500 mt-1 ml-1';
        usernameAvailable = false;
        return;
    }
    
    if (!/^[a-zA-Z0-9._]+$/.test(username)) {
        statusEl.innerHTML = '<i class="fas fa-times text-red-500"></i>';
        statusEl.classList.remove('hidden');
        hintEl.textContent = 'Csak betűk, számok, pont és aláhúzás';
        hintEl.className = 'text-xs text-red-500 mt-1 ml-1';
        usernameAvailable = false;
        return;
    }
    
    usernameCheckTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`${API}/auth/check-username/${username}`);
            const data = await res.json();
            
            if (data.available) {
                statusEl.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                hintEl.textContent = 'Ez a felhasználónév elérhető!';
                hintEl.className = 'text-xs text-green-500 mt-1 ml-1';
                usernameAvailable = true;
            } else {
                statusEl.innerHTML = '<i class="fas fa-times text-red-500"></i>';
                hintEl.textContent = 'Ez a felhasználónév már foglalt!';
                hintEl.className = 'text-xs text-red-500 mt-1 ml-1';
                usernameAvailable = false;
            }
            statusEl.classList.remove('hidden');
        } catch (e) {}
    }, 500);
}

async function register() {
    const firstName = document.getElementById('regFirstName').value.trim();
    const lastName = document.getElementById('regLastName').value.trim();
    const username = document.getElementById('regUsername').value.trim();
    const email = document.getElementById('regEmail').value.trim();
    const password = document.getElementById('regPassword').value;
    
    if (!firstName || !lastName || !username || !email || !password) {
        return toast('Töltsd ki az összes mezőt!', 'error');
    }
    
    if (!usernameAvailable) {
        return toast('Válassz egy elérhető felhasználónevet!', 'error');
    }
    
    if (password.length < 6) {
        return toast('A jelszó minimum 6 karakter legyen!', 'error');
    }
    
    try {
        const data = await api('/auth/register', {
            method: 'POST',
            body: JSON.stringify({ firstName, lastName, username, email, password })
        });
        token = data.token;
        currentUser = data.user;
        localStorage.setItem('token', token);
        initApp();
        toast('Sikeres regisztráció!', 'success');
    } catch (e) {}
}

function logout() {
    token = null;
    currentUser = null;
    localStorage.removeItem('token');
    socket?.disconnect();
    openChats.clear();
    document.getElementById('chatWindowsContainer').innerHTML = '';
    document.getElementById('authPage').classList.remove('hidden');
    document.getElementById('mainApp').classList.add('hidden');
    toast('Kijelentkeztél', 'info');
}

// ============ APP INIT ============
async function initApp() {
    document.getElementById('authPage').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    
    // Socket
    socket = io();
    socket.emit('join', currentUser._id);
    
    // Frissítjük a currentUser-t a friends tömbbel
    try {
        const fullUser = await api(`/users/${currentUser._id}`);
        currentUser.friends = fullUser.friends;
    } catch (e) {}
    
    socket.on('newMessage', (msg) => {
        const odorId = msg.from._id === currentUser._id ? msg.to._id : msg.from._id;
        // Update floating chat if open
        if (openChats.has(odorId)) {
            loadChatMessages(odorId);
        } else if (msg.from._id !== currentUser._id) {
            // Open new chat window for incoming message
            openChatWindow(msg.from._id);
        }
        // Update messenger if open
        if (currentMessengerChat === odorId) {
            loadMessengerMessages(odorId);
        }
        loadMessengerChatList();
        updateBadges();
    });
    
    socket.on('typing', (userId) => {
        showTyping(userId);
    });
    
    socket.on('stopTyping', (userId) => {
        hideTyping(userId);
    });
    
    socket.on('newPost', () => loadPosts());
    socket.on('updatePost', () => loadPosts());
    socket.on('deletePost', () => loadPosts());
    socket.on('notification', () => updateBadges());
    socket.on('incomingCall', (data) => handleIncomingCall(data));
    socket.on('callEnded', () => endCall());
    
    // Load users
    allUsers = await api('/users');
    
    // Update UI
    updateUserUI();
    updateBadges();
    loadRightSidebar();
    
    // Socket events for groups
    socket.on('newGroupMessage', (data) => {
        if (currentGroupChat && currentGroupChat._id === data.groupId) {
            loadGroupMessages(data.groupId);
        }
        loadSidebarGroups();
    });
    
    socket.on('groupTyping', (data) => {
        if (currentGroupChat && currentGroupChat._id === data.groupId && data.userId !== currentUser._id) {
            document.getElementById('groupChatTyping').classList.remove('hidden');
            document.getElementById('groupTypingText').textContent = `${data.userName} gépel...`;
        }
    });
    
    socket.on('stopGroupTyping', (data) => {
        if (currentGroupChat && currentGroupChat._id === data.groupId) {
            document.getElementById('groupChatTyping').classList.add('hidden');
        }
    });
    
    socket.on('userOnline', () => loadRightSidebar());
    socket.on('userOffline', () => loadRightSidebar());
    
    // Return promise
    return Promise.resolve();
}

function updateUserUI() {
    const avatar = getAvatar(currentUser);
    document.getElementById('navAvatar').src = avatar;
    document.getElementById('menuAvatar').src = avatar;
    document.getElementById('feedAvatar').src = avatar;
    document.getElementById('postModalAvatar').src = avatar;
    document.getElementById('menuName').textContent = currentUser.name;
    document.getElementById('postModalName').textContent = currentUser.name;
    
    if (currentUser.isAdmin) {
        document.getElementById('adminMenuItem').classList.remove('hidden');
    }
}

async function updateBadges() {
    try {
        const data = await api('/notifications/unread');
        const notifBadge = document.getElementById('notifBadge');
        const msgBadge = document.getElementById('msgBadge');
        
        if (data.notifications > 0) {
            notifBadge.textContent = data.notifications;
            notifBadge.classList.remove('hidden');
        } else {
            notifBadge.classList.add('hidden');
        }
        
        if (data.messages > 0) {
            msgBadge.textContent = data.messages;
            msgBadge.classList.remove('hidden');
        } else {
            msgBadge.classList.add('hidden');
        }
    } catch (e) {}
}

// ============ NAVIGATION ============
function navigate(page, param = null) {
    // Hide all pages
    document.querySelectorAll('[id$="Page"]').forEach(p => p.classList.add('hidden'));
    
    // Update nav
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('nav-active'));
    const navBtn = document.getElementById(`nav${page.charAt(0).toUpperCase() + page.slice(1)}`);
    if (navBtn) navBtn.classList.add('nav-active');
    
    // Show page
    document.getElementById(page + 'Page')?.classList.remove('hidden');
    
    // Close menus
    document.getElementById('userMenu').classList.add('hidden');
    document.getElementById('searchDropdown').classList.add('hidden');
    
    // Load content
    switch(page) {
        case 'feed': loadFeed(); break;
        case 'messenger': loadMessenger(); break;
        case 'friends': loadFriends(); break;
        case 'profile': loadProfile(param || currentUser._id); break;
        case 'notifications': loadNotifications(); break;
        case 'admin': loadAdmin(); break;
    }
}

// ============ SEARCH ============
function handleSearch(query) {
    const dropdown = document.getElementById('searchDropdown');
    const results = document.getElementById('searchResults');
    
    if (!query.trim()) {
        dropdown.classList.add('hidden');
        return;
    }
    
    const queryLower = query.toLowerCase();
    const filtered = allUsers.filter(u => {
        const firstName = (u.firstName || '').toLowerCase();
        const lastName = (u.lastName || '').toLowerCase();
        const fullName = `${firstName} ${lastName}`;
        const username = (u.username || '').toLowerCase();
        const email = (u.email || '').toLowerCase();
        
        return fullName.includes(queryLower) ||
               username.includes(queryLower) ||
               email.includes(queryLower) ||
               firstName.includes(queryLower) ||
               lastName.includes(queryLower);
    });
    
    if (filtered.length === 0) {
        results.innerHTML = '<p class="text-gray-500 text-center py-4">Nincs találat</p>';
    } else {
        results.innerHTML = filtered.map(u => {
            const displayName = getUserName(u);
            return `
                <div onclick="navigateToProfile('${u.username || u._id}')" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 cursor-pointer transition">
                    <img src="${getAvatar(u)}" class="w-10 h-10 rounded-full">
                    <div>
                        <p class="font-semibold text-gray-800 dark:text-white text-sm">${displayName}</p>
                        <p class="text-xs text-gray-500">@${u.username || 'user'}</p>
                    </div>
                </div>
            `;
        }).join('');
    }
    
    dropdown.classList.remove('hidden');
}

function navigateToProfile(usernameOrId) {
    if (usernameOrId) {
        window.history.pushState({}, '', `/${usernameOrId}`);
        navigate('profile', usernameOrId);
    }
}

function showSearchDropdown() {
    const query = document.getElementById('searchInput').value;
    if (query.trim()) {
        document.getElementById('searchDropdown').classList.remove('hidden');
    }
}

function hideSearchDropdown() {
    document.getElementById('searchDropdown').classList.add('hidden');
}

// ============ DARK MODE ============
function toggleDarkMode() {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('darkMode', isDark);
    document.getElementById('themeIcon').className = `fas fa-${isDark ? 'sun' : 'moon'} text-gray-700 dark:text-gray-300`;
}

function toggleUserMenu() {
    document.getElementById('userMenu').classList.toggle('hidden');
}

// ============ FEED ============
async function loadFeed() {
    await loadStories();
    await loadPosts();
}

async function loadStories() {
    try {
        const stories = await api('/stories');
        const container = document.getElementById('storiesContainer');
        
        container.innerHTML = `
            <div onclick="openStoryModal()" class="flex-shrink-0 cursor-pointer group">
                <div class="w-28 h-48 bg-gray-100 dark:bg-dark-300 rounded-xl relative overflow-hidden hover:brightness-95 transition">
                    <img src="${getAvatar(currentUser)}" class="w-full h-3/4 object-cover">
                    <div class="absolute bottom-0 inset-x-0 h-1/3 bg-white dark:bg-dark-200 flex flex-col items-center justify-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center -mt-4 ring-4 ring-white dark:ring-dark-200">
                            <i class="fas fa-plus text-white text-sm"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-700 dark:text-gray-300 mt-1">Történet</span>
                    </div>
                </div>
            </div>
            ${stories.map(s => {
                const storyAuthorName = getUserName(s.author);
                return `
                    <div onclick="viewStory('${s._id}')" class="flex-shrink-0 cursor-pointer group">
                        <div class="story-ring rounded-xl">
                            <div class="w-28 h-48 rounded-xl relative overflow-hidden bg-gray-900">
                                <img src="${s.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-300">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                                <img src="${getAvatar(s.author)}" class="absolute top-2 left-2 w-8 h-8 rounded-full ring-2 ring-blue-500">
                                <p class="absolute bottom-2 left-2 right-2 text-white text-xs font-medium truncate">${storyAuthorName}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        `;
    } catch (e) {}
}

async function loadPosts() {
    try {
        const posts = await api('/posts');
        renderPosts(posts, 'postsContainer');
    } catch (e) {}
}

function renderPosts(posts, containerId) {
    const container = document.getElementById(containerId);
    if (!posts.length) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">Még nincs bejegyzés</div>';
        return;
    }
    
    container.innerHTML = posts.map(post => {
        const liked = post.likes.includes(currentUser._id);
        const canDelete = post.author._id === currentUser._id || currentUser.isAdmin || currentUser.isOwner;
        const authorName = getUserName(post.author);
        const authorBadge = getUserBadge(post.author);
        
        return `
            <div class="bg-white dark:bg-dark-200 rounded-xl shadow slide-up">
                <div class="p-4">
                    <div class="flex items-center gap-3">
                        <img src="${getAvatar(post.author)}" class="w-10 h-10 rounded-full cursor-pointer hover:brightness-95 transition" onclick="navigateToProfile('${post.author.username || post.author._id}')">
                        <div class="flex-1">
                            <p class="font-semibold text-gray-800 dark:text-white text-sm cursor-pointer hover:underline inline-flex items-center flex-wrap" onclick="navigateToProfile('${post.author.username || post.author._id}')">${authorName}${authorBadge}</p>
                            <p class="text-xs text-gray-500">${timeAgo(post.createdAt)} · <i class="fas fa-globe-americas"></i></p>
                        </div>
                        ${canDelete ? `
                            <button onclick="deletePost('${post._id}')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center transition">
                                <i class="fas fa-trash text-gray-400 hover:text-red-500 text-sm"></i>
                            </button>
                        ` : ''}
                    </div>
                    ${post.content ? `<p class="mt-3 text-gray-800 dark:text-white whitespace-pre-line">${post.content}</p>` : ''}
                </div>
                ${post.image ? `<img src="${post.image}" class="w-full max-h-[500px] object-cover">` : ''}
                <div class="px-4 py-2 flex items-center justify-between text-sm text-gray-500 border-b border-gray-100 dark:border-dark-300">
                    <div class="flex items-center gap-1">
                        ${post.likes.length > 0 ? `
                            <div class="w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-thumbs-up text-white text-xs"></i>
                            </div>
                            <span>${post.likes.length}</span>
                        ` : ''}
                    </div>
                    <span>${post.comments.length} hozzászólás</span>
                </div>
                <div class="px-2 py-1 flex border-b border-gray-100 dark:border-dark-300">
                    <button onclick="likePost('${post._id}')" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition ${liked ? 'text-blue-500' : 'text-gray-500'}">
                        <i class="${liked ? 'fas' : 'far'} fa-thumbs-up"></i>
                        <span class="font-medium text-sm">Tetszik</span>
                    </button>
                    <button onclick="document.getElementById('comment-${post._id}').focus()" class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-gray-500">
                        <i class="far fa-comment"></i>
                        <span class="font-medium text-sm">Hozzászólás</span>
                    </button>
                    <button class="flex-1 flex items-center justify-center gap-2 py-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 transition text-gray-500">
                        <i class="fas fa-share"></i>
                        <span class="font-medium text-sm">Megosztás</span>
                    </button>
                </div>
                <div class="p-4">
                    ${post.comments.slice(-3).map(c => {
                        const commentAuthorName = getUserName(c.author);
                        const commentBadge = getUserBadge(c.author);
                        return `
                            <div class="flex gap-2 mb-2">
                                <img src="${getAvatar(c.author)}" class="w-8 h-8 rounded-full">
                                <div class="bg-gray-100 dark:bg-dark-300 rounded-2xl px-3 py-2">
                                    <p class="font-semibold text-xs text-gray-800 dark:text-white inline-flex items-center flex-wrap">${commentAuthorName}${commentBadge}</p>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">${c.text}</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    <div class="flex gap-2 mt-2">
                        <img src="${getAvatar(currentUser)}" class="w-8 h-8 rounded-full">
                        <input type="text" id="comment-${post._id}" placeholder="Írj hozzászólást..." 
                            class="flex-1 bg-gray-100 dark:bg-dark-300 rounded-full px-4 py-2 text-sm outline-none text-gray-800 dark:text-white"
                            onkeypress="if(event.key==='Enter')addComment('${post._id}', this.value)">
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

async function likePost(postId) {
    try {
        await api(`/posts/${postId}/like`, { method: 'POST' });
    } catch (e) {}
}

async function addComment(postId, text) {
    if (!text.trim()) return;
    try {
        await api(`/posts/${postId}/comment`, {
            method: 'POST',
            body: JSON.stringify({ text })
        });
    } catch (e) {}
}

async function deletePost(postId) {
    if (!confirm('Biztosan törlöd ezt a bejegyzést?')) return;
    try {
        await api(`/posts/${postId}`, { method: 'DELETE' });
        toast('Bejegyzés törölve', 'success');
    } catch (e) {}
}

// ============ POST MODAL ============
function openPostModal() {
    document.getElementById('postModal').classList.remove('hidden');
    document.getElementById('postContent').focus();
}

function closePostModal() {
    document.getElementById('postModal').classList.add('hidden');
    document.getElementById('postContent').value = '';
    document.getElementById('postImagePreview').classList.add('hidden');
    document.getElementById('postImageInput').value = '';
}

function previewPostImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('postPreviewImg').src = e.target.result;
            document.getElementById('postImagePreview').classList.remove('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function removePostImage() {
    document.getElementById('postImagePreview').classList.add('hidden');
    document.getElementById('postImageInput').value = '';
}

async function createPost() {
    const content = document.getElementById('postContent').value;
    const imageEl = document.getElementById('postPreviewImg');
    const hasImage = !document.getElementById('postImagePreview').classList.contains('hidden');
    
    if (!content && !hasImage) {
        return toast('Írj valamit vagy adj hozzá képet!', 'error');
    }
    
    try {
        let imageUrl = '';
        if (hasImage) {
            toast('Kép feltöltése...', 'info');
            imageUrl = await uploadImage(imageEl.src);
        }
        
        await api('/posts', {
            method: 'POST',
            body: JSON.stringify({ content, image: imageUrl })
        });
        closePostModal();
        toast('Bejegyzés közzétéve!', 'success');
    } catch (e) {}
}

// ============ STORY MODAL ============
function openStoryModal() {
    document.getElementById('storyModal').classList.remove('hidden');
    document.getElementById('storyCreate').classList.remove('hidden');
    document.getElementById('storyView').classList.add('hidden');
}

function closeStoryModal() {
    document.getElementById('storyModal').classList.add('hidden');
    document.getElementById('storyPreview').classList.add('hidden');
    document.getElementById('storyUploadLabel').classList.remove('hidden');
    document.getElementById('storyImageInput').value = '';
    currentStory = null;
}

function previewStoryImage(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('storyPreviewImg').src = e.target.result;
            document.getElementById('storyPreview').classList.remove('hidden');
            document.getElementById('storyUploadLabel').classList.add('hidden');
        };
        reader.readAsDataURL(input.files[0]);
    }
}

function removeStoryImage() {
    document.getElementById('storyPreview').classList.add('hidden');
    document.getElementById('storyUploadLabel').classList.remove('hidden');
    document.getElementById('storyImageInput').value = '';
}

async function createStory() {
    const image = document.getElementById('storyPreviewImg').src;
    if (!image || document.getElementById('storyPreview').classList.contains('hidden')) {
        return toast('Válassz egy képet!', 'error');
    }
    
    try {
        toast('Kép feltöltése...', 'info');
        const imageUrl = await uploadImage(image);
        
        await api('/stories', {
            method: 'POST',
            body: JSON.stringify({ image: imageUrl })
        });
        closeStoryModal();
        loadStories();
        toast('Történet megosztva!', 'success');
    } catch (e) {}
}

async function viewStory(storyId) {
    try {
        const stories = await api('/stories');
        const story = stories.find(s => s._id === storyId);
        if (!story) return;
        
        currentStory = story;
        
        document.getElementById('storyModal').classList.remove('hidden');
        document.getElementById('storyCreate').classList.add('hidden');
        document.getElementById('storyView').classList.remove('hidden');
        
        const storyAuthorName = getUserName(story.author);
        
        document.getElementById('storyViewAvatar').src = getAvatar(story.author);
        document.getElementById('storyViewName').textContent = storyAuthorName;
        document.getElementById('storyViewTime').textContent = timeAgo(story.createdAt);
        document.getElementById('storyViewImg').src = story.image;
        
        const deleteBtn = document.getElementById('storyDeleteBtn');
        if (story.author._id === currentUser._id || currentUser.isAdmin) {
            deleteBtn.classList.remove('hidden');
        } else {
            deleteBtn.classList.add('hidden');
        }
    } catch (e) {}
}

async function deleteStory() {
    if (!currentStory) return;
    if (!confirm('Biztosan törlöd ezt a történetet?')) return;
    
    try {
        await api(`/stories/${currentStory._id}`, { method: 'DELETE' });
        closeStoryModal();
        loadStories();
        toast('Történet törölve!', 'success');
    } catch (e) {}
}

// ============ MESSENGER PAGE ============
async function loadMessenger() {
    await loadMessengerChatList();
}

async function loadMessengerChatList() {
    try {
        const convs = await api('/messages/conversations');
        const container = document.getElementById('messengerChatList');
        
        // Combine with all users who don't have conversations yet
        const convUserIds = convs.map(c => c.user._id);
        const odorUsers = allUsers.filter(u => !convUserIds.includes(u._id));
        
        const allChats = [
            ...convs.map(c => ({ user: c.user, lastMessage: c.lastMessage, unread: c.unread })),
            ...odorUsers.map(u => ({ user: u, lastMessage: null, unread: 0 }))
        ];
        
        container.innerHTML = allChats.map(c => `
            <div onclick="openMessengerChat('${c.user._id}')" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 cursor-pointer transition ${currentMessengerChat === c.user._id ? 'bg-blue-50 dark:bg-blue-900/20' : ''}">
                <div class="relative">
                    <img src="${getAvatar(c.user)}" class="w-12 h-12 rounded-full">
                    <span class="absolute bottom-0 right-0 w-3 h-3 ${c.user.isOnline ? 'bg-green-500' : 'bg-gray-400'} border-2 border-white dark:border-dark-200 rounded-full"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <p class="font-semibold text-gray-800 dark:text-white text-sm">${c.user.name}</p>
                    <p class="text-xs text-gray-500 truncate">${c.lastMessage?.text || 'Kezdj el beszélgetni'}</p>
                </div>
                ${c.unread > 0 ? `<span class="bg-blue-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">${c.unread}</span>` : ''}
            </div>
        `).join('');
    } catch (e) {}
}

function filterChatList(query) {
    const items = document.querySelectorAll('#messengerChatList > div');
    items.forEach(item => {
        const name = item.querySelector('.font-semibold').textContent.toLowerCase();
        item.style.display = name.includes(query.toLowerCase()) ? '' : 'none';
    });
}

async function openMessengerChat(userId) {
    currentMessengerChat = userId;
    const user = allUsers.find(u => u._id === userId);
    if (!user) return;
    
    document.getElementById('messengerWelcome').classList.add('hidden');
    document.getElementById('messengerActiveChat').classList.remove('hidden');
    
    // Header
    document.getElementById('messengerChatHeader').innerHTML = `
        <div class="flex items-center gap-3">
            <div class="relative">
                <img src="${getAvatar(user)}" class="w-10 h-10 rounded-full cursor-pointer" onclick="navigate('profile', '${user._id}')">
                <span class="absolute bottom-0 right-0 w-2.5 h-2.5 ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'} border-2 border-white dark:border-dark-200 rounded-full"></span>
            </div>
            <div>
                <p class="font-semibold text-gray-800 dark:text-white cursor-pointer hover:underline" onclick="navigate('profile', '${user._id}')">${user.name}</p>
                <p class="text-xs ${user.isOnline ? 'text-green-500' : 'text-gray-500'}">${user.isOnline ? 'Aktív most' : 'Offline'}</p>
            </div>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="startCall('${user._id}', 'audio')" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition" title="Hanghívás">
                <i class="fas fa-phone"></i>
            </button>
            <button onclick="startCall('${user._id}', 'video')" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition" title="Videóhívás">
                <i class="fas fa-video"></i>
            </button>
            <button onclick="openChatWindow('${user._id}')" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition" title="Külön ablakban">
                <i class="fas fa-external-link-alt"></i>
            </button>
        </div>
    `;
    
    await loadMessengerMessages(userId);
    loadMessengerChatList();
}

async function loadMessengerMessages(userId) {
    try {
        const messages = await api(`/messages/${userId}`);
        const container = document.getElementById('messengerMessages');
        
        container.innerHTML = messages.map(m => `
            <div class="flex ${m.from === currentUser._id ? 'justify-end' : 'justify-start'}">
                <div class="${m.from === currentUser._id 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 dark:bg-dark-300 text-gray-800 dark:text-white'} rounded-2xl px-4 py-2 max-w-xs lg:max-w-md">
                    ${m.text}
                </div>
            </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
    } catch (e) {}
}

let messengerTypingTimeout;
function handleMessengerTyping() {
    if (currentMessengerChat) {
        socket.emit('typing', { to: currentMessengerChat, from: currentUser._id });
        clearTimeout(messengerTypingTimeout);
        messengerTypingTimeout = setTimeout(() => {
            socket.emit('stopTyping', { to: currentMessengerChat, from: currentUser._id });
        }, 1000);
    }
}

async function sendMessengerMessage() {
    const input = document.getElementById('messengerInput');
    const text = input.value.trim();
    if (!text || !currentMessengerChat) return;
    
    try {
        await api('/messages', {
            method: 'POST',
            body: JSON.stringify({ to: currentMessengerChat, text })
        });
        input.value = '';
        socket.emit('stopTyping', { to: currentMessengerChat, from: currentUser._id });
    } catch (e) {}
}

// ============ FLOATING CHAT WINDOWS ============
async function openChatWindow(userId) {
    if (openChats.has(userId)) {
        const existing = openChats.get(userId);
        existing.classList.remove('minimized');
        return;
    }
    
    if (openChats.size >= 3) {
        const firstKey = openChats.keys().next().value;
        closeChatWindow(firstKey);
    }
    
    const user = allUsers.find(u => u._id === userId);
    if (!user) return;
    
    const win = document.createElement('div');
    win.className = 'chat-window bg-white dark:bg-dark-200 slide-up';
    win.id = `chat-${userId}`;
    win.innerHTML = `
        <div class="chat-header h-11 flex items-center justify-between px-2 bg-white dark:bg-dark-200 border-b border-gray-200 dark:border-dark-300 cursor-pointer" onclick="toggleChatWindow('${userId}')">
            <div class="flex items-center gap-2">
                <div class="relative">
                    <img src="${getAvatar(user)}" class="w-8 h-8 rounded-full">
                    <span class="absolute bottom-0 right-0 w-2 h-2 ${user.isOnline ? 'bg-green-500' : 'bg-gray-400'} border border-white dark:border-dark-200 rounded-full"></span>
                </div>
                <span class="font-semibold text-gray-800 dark:text-white text-sm">${user.name}</span>
            </div>
            <div class="flex items-center">
                <button onclick="event.stopPropagation(); startCall('${userId}', 'audio')" class="w-7 h-7 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500" title="Hanghívás">
                    <i class="fas fa-phone text-sm"></i>
                </button>
                <button onclick="event.stopPropagation(); startCall('${userId}', 'video')" class="w-7 h-7 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500" title="Videóhívás">
                    <i class="fas fa-video text-sm"></i>
                </button>
                <button onclick="event.stopPropagation(); toggleChatWindow('${userId}')" class="w-7 h-7 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-gray-500">
                    <i class="fas fa-minus text-sm"></i>
                </button>
                <button onclick="event.stopPropagation(); closeChatWindow('${userId}')" class="w-7 h-7 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-gray-500">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>
        </div>
        <div class="chat-body flex-1 overflow-y-auto p-3 space-y-2 bg-white dark:bg-dark-100" id="chat-messages-${userId}"></div>
        <div id="chat-typing-${userId}" class="hidden px-3 py-1">
            <div class="flex items-center gap-2 text-gray-500 text-xs">
                <div class="flex gap-1">
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            </div>
        </div>
        <div class="chat-footer p-2 border-t border-gray-200 dark:border-dark-300 bg-white dark:bg-dark-200 flex items-center gap-1">
            <button class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500">
                <i class="fas fa-plus-circle"></i>
            </button>
            <div class="flex-1">
                <input type="text" id="chat-input-${userId}" placeholder="Aa" 
                    class="w-full bg-gray-100 dark:bg-dark-300 rounded-full px-3 py-1.5 text-sm outline-none text-gray-800 dark:text-white"
                    oninput="handleChatTyping('${userId}')"
                    onkeypress="if(event.key==='Enter')sendChatMessage('${userId}')">
            </div>
            <button onclick="sendChatMessage('${userId}')" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    `;
    
    document.getElementById('chatWindowsContainer').appendChild(win);
    openChats.set(userId, win);
    await loadChatMessages(userId);
}

function toggleChatWindow(userId) {
    const win = openChats.get(userId);
    if (win) win.classList.toggle('minimized');
}

function closeChatWindow(userId) {
    const win = openChats.get(userId);
    if (win) {
        win.remove();
        openChats.delete(userId);
    }
}

async function loadChatMessages(userId) {
    try {
        const messages = await api(`/messages/${userId}`);
        const container = document.getElementById(`chat-messages-${userId}`);
        if (!container) return;
        
        container.innerHTML = messages.map(m => `
            <div class="flex ${m.from === currentUser._id ? 'justify-end' : 'justify-start'}">
                <div class="${m.from === currentUser._id 
                    ? 'bg-blue-500 text-white' 
                    : 'bg-gray-200 dark:bg-dark-300 text-gray-800 dark:text-white'} rounded-2xl px-3 py-1.5 max-w-[200px] text-sm">
                    ${m.text}
                </div>
            </div>
        `).join('');
        
        container.scrollTop = container.scrollHeight;
    } catch (e) {}
}

let chatTypingTimeouts = {};
function handleChatTyping(userId) {
    socket.emit('typing', { to: userId, from: currentUser._id });
    clearTimeout(chatTypingTimeouts[userId]);
    chatTypingTimeouts[userId] = setTimeout(() => {
        socket.emit('stopTyping', { to: userId, from: currentUser._id });
    }, 1000);
}

async function sendChatMessage(userId) {
    const input = document.getElementById(`chat-input-${userId}`);
    const text = input.value.trim();
    if (!text) return;
    
    try {
        await api('/messages', {
            method: 'POST',
            body: JSON.stringify({ to: userId, text })
        });
        input.value = '';
        socket.emit('stopTyping', { to: userId, from: currentUser._id });
    } catch (e) {}
}

function showTyping(userId) {
    // In floating chat
    const chatTyping = document.getElementById(`chat-typing-${userId}`);
    if (chatTyping) chatTyping.classList.remove('hidden');
    
    // In messenger
    if (currentMessengerChat === userId) {
        document.getElementById('messengerTyping').classList.remove('hidden');
    }
}

function hideTyping(userId) {
    const chatTyping = document.getElementById(`chat-typing-${userId}`);
    if (chatTyping) chatTyping.classList.add('hidden');
    
    if (currentMessengerChat === userId) {
        document.getElementById('messengerTyping').classList.add('hidden');
    }
}

// ============ CALLS ============
async function startCall(userId, type) {
    const user = allUsers.find(u => u._id === userId);
    if (!user) return;
    
    callState = { active: true, muted: false, videoOff: false, userId };
    
    document.getElementById('callAvatar').src = getAvatar(user);
    document.getElementById('callName').textContent = user.name;
    document.getElementById('callStatus').textContent = type === 'video' ? 'Videóhívás...' : 'Hanghívás...';
    document.getElementById('callModal').classList.remove('hidden');
    document.getElementById('acceptCallBtn').classList.add('hidden');
    document.getElementById('callControls').classList.add('hidden');
    
    socket.emit('startCall', { to: userId, from: currentUser._id, type });
    
    setTimeout(() => {
        if (callState.active) {
            document.getElementById('callStatus').textContent = 'Kapcsolódva';
            document.getElementById('callControls').classList.remove('hidden');
        }
    }, 2000);
}

function handleIncomingCall(data) {
    callState = { active: true, muted: false, videoOff: false, userId: data.from };
    
    document.getElementById('callAvatar').src = data.avatar;
    document.getElementById('callName').textContent = data.name;
    document.getElementById('callStatus').textContent = data.type === 'video' ? 'Bejövő videóhívás...' : 'Bejövő hanghívás...';
    document.getElementById('callModal').classList.remove('hidden');
    document.getElementById('acceptCallBtn').classList.remove('hidden');
    document.getElementById('callControls').classList.add('hidden');
}

function acceptCall() {
    document.getElementById('callStatus').textContent = 'Kapcsolódva';
    document.getElementById('acceptCallBtn').classList.add('hidden');
    document.getElementById('callControls').classList.remove('hidden');
    socket.emit('acceptCall', { to: callState.userId, from: currentUser._id });
}

function endCall() {
    document.getElementById('callModal').classList.add('hidden');
    if (callState.active && callState.userId) {
        socket.emit('endCall', { to: callState.userId });
    }
    callState = { active: false, muted: false, videoOff: false, userId: null };
}

function toggleMute() {
    callState.muted = !callState.muted;
    const btn = document.getElementById('muteBtn');
    btn.innerHTML = `<i class="fas fa-microphone${callState.muted ? '-slash' : ''}"></i>`;
    btn.classList.toggle('bg-red-500/50', callState.muted);
}

function toggleVideo() {
    callState.videoOff = !callState.videoOff;
    const btn = document.getElementById('videoBtn');
    btn.innerHTML = `<i class="fas fa-video${callState.videoOff ? '-slash' : ''}"></i>`;
    btn.classList.toggle('bg-red-500/50', callState.videoOff);
}

// ============ FRIENDS ============
async function loadFriends() {
    showFriendsTab('all');
}

async function showFriendsTab(tab) {
    document.querySelectorAll('.friends-tab').forEach(btn => {
        btn.classList.remove('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600');
        btn.classList.add('bg-gray-100', 'dark:bg-dark-300', 'text-gray-700', 'dark:text-gray-300');
    });
    event?.target.classList.remove('bg-gray-100', 'dark:bg-dark-300', 'text-gray-700', 'dark:text-gray-300');
    event?.target.classList.add('bg-blue-100', 'dark:bg-blue-900/30', 'text-blue-600');
    
    const content = document.getElementById('friendsContent');
    
    try {
        if (tab === 'all') {
            const user = await api(`/users/${currentUser._id}`);
            content.innerHTML = user.friends?.length ? `
                <div class="grid md:grid-cols-2 gap-4">
                    ${user.friends.map(f => `
                        <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-dark-300 rounded-xl">
                            <img src="${getAvatar(f)}" class="w-16 h-16 rounded-xl cursor-pointer" onclick="navigateToProfile('${f.username || f._id}')">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800 dark:text-white cursor-pointer hover:underline" onclick="navigateToProfile('${f.username || f._id}')">${getUserName(f)}</p>
                                <p class="text-sm text-gray-500">@${f.username || 'user'}</p>
                            </div>
                            <button onclick="openChatWindow('${f._id}')" class="w-10 h-10 bg-gray-200 dark:bg-dark-400 rounded-full flex items-center justify-center hover:bg-blue-100 dark:hover:bg-blue-900/30 transition">
                                <i class="fab fa-facebook-messenger text-gray-600 dark:text-gray-300"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-center text-gray-500 py-12">Még nincsenek barátaid</p>';
        } else if (tab === 'requests') {
            const requests = await api('/friends/requests');
            content.innerHTML = requests.length ? `
                <div class="space-y-4">
                    ${requests.map(r => `
                        <div class="flex items-center gap-4 p-4 bg-gray-50 dark:bg-dark-300 rounded-xl">
                            <img src="${getAvatar(r.from)}" class="w-16 h-16 rounded-xl">
                            <div class="flex-1">
                                <p class="font-semibold text-gray-800 dark:text-white">${getUserName(r.from)}</p>
                                <p class="text-sm text-gray-500">@${r.from.username || 'user'}</p>
                            </div>
                            <button onclick="acceptFriend('${r._id}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition">Megerősítés</button>
                            <button onclick="declineFriend('${r._id}')" class="px-4 py-2 bg-gray-200 dark:bg-dark-400 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-dark-500 transition">Törlés</button>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-center text-gray-500 py-12">Nincs függő barátkérelem</p>';
        } else {
            const suggestions = await api('/friends/suggestions');
            content.innerHTML = suggestions.length ? `
                <div class="grid md:grid-cols-3 gap-4">
                    ${suggestions.map(u => `
                        <div class="bg-gray-50 dark:bg-dark-300 rounded-xl overflow-hidden">
                            <img src="${getAvatar(u)}" class="w-full h-40 object-cover cursor-pointer" onclick="navigateToProfile('${u.username || u._id}')">
                            <div class="p-4">
                                <p class="font-semibold text-gray-800 dark:text-white mb-1 cursor-pointer hover:underline" onclick="navigateToProfile('${u.username || u._id}')">${getUserName(u)}</p>
                                <p class="text-sm text-gray-500 mb-3">@${u.username || 'user'}</p>
                                <button onclick="sendFriendRequest('${u._id}')" class="w-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 py-2 rounded-lg font-medium hover:bg-blue-200 dark:hover:bg-blue-900/50 transition">
                                    <i class="fas fa-user-plus mr-2"></i>Barátnak jelölés
                                </button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<p class="text-center text-gray-500 py-12">Nincs több javaslat</p>';
        }
    } catch (e) {}
}

async function sendFriendRequest(userId) {
    try {
        await api(`/friends/request/${userId}`, { method: 'POST' });
        toast('Barátkérelem elküldve!', 'success');
        showFriendsTab('suggestions');
    } catch (e) {}
}

async function acceptFriend(requestId) {
    try {
        await api(`/friends/accept/${requestId}`, { method: 'POST' });
        currentUser = await api('/auth/me');
        toast('Barátkérelem elfogadva!', 'success');
        showFriendsTab('requests');
    } catch (e) {}
}

async function declineFriend(requestId) {
    try {
        await api(`/friends/decline/${requestId}`, { method: 'POST' });
        showFriendsTab('requests');
    } catch (e) {}
}

// ============ PROFILE ============
let currentProfileId = null;

function getRelationshipText(status) {
    const texts = {
        'single': 'Egyedülálló',
        'in_relationship': 'Kapcsolatban',
        'engaged': 'Jegyben',
        'married': 'Házas',
        'complicated': 'Bonyolult'
    };
    return texts[status] || '';
}

async function loadProfile(userIdOrUsername) {
    try {
        let user;
        let userId;
        
        // Ellenőrizzük, hogy ID vagy username
        if (userIdOrUsername.match(/^[0-9a-fA-F]{24}$/)) {
            // Ez egy MongoDB ID
            user = await api(`/users/${userIdOrUsername}`);
            userId = userIdOrUsername;
        } else {
            // Ez egy username
            user = await api(`/users/username/${userIdOrUsername}`);
            userId = user._id;
        }
        
        currentProfileId = userId;
        const posts = await api(`/posts/user/${userId}`);
        
        document.getElementById('profileAvatar').src = getAvatar(user);
        document.getElementById('profileCover').src = user.cover || '';
        
        // Név és jelvény együtt
        const nameEl = document.getElementById('profileName');
        nameEl.innerHTML = `${getUserName(user)}${getUserBadge(user, 'lg')}`;
        
        document.getElementById('profileUsername').textContent = `@${user.username || 'user'}`;
        document.getElementById('profileFriendCount').textContent = `${user.friends?.length || 0} barát`;
        document.getElementById('profileBio').textContent = user.bio || '';
        
        // Info panel feltöltése
        const infoContent = document.getElementById('profileInfoContent');
        let infoHTML = '';
        
        if (user.bio) {
            infoHTML += `<p class="text-gray-600 dark:text-gray-400 text-center pb-3 border-b border-gray-100 dark:border-dark-300">${user.bio}</p>`;
        }
        
        if (user.workplace) {
            infoHTML += `
                <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-briefcase w-5 text-gray-400"></i>
                    <span>${user.jobTitle ? user.jobTitle + ' - ' : ''}${user.workplace}</span>
                </div>`;
        }
        
        if (user.college) {
            infoHTML += `
                <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-graduation-cap w-5 text-gray-400"></i>
                    <span>Tanult: ${user.college}</span>
                </div>`;
        }
        
        if (user.school) {
            infoHTML += `
                <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-school w-5 text-gray-400"></i>
                    <span>Tanult: ${user.school}</span>
                </div>`;
        }
        
        if (user.currentCity) {
            infoHTML += `
                <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-home w-5 text-gray-400"></i>
                    <span>Lakóhely: ${user.currentCity}</span>
                </div>`;
        }
        
        if (user.hometown) {
            infoHTML += `
                <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-map-marker-alt w-5 text-gray-400"></i>
                    <span>Szülőváros: ${user.hometown}</span>
                </div>`;
        }
        
        if (user.relationship) {
            infoHTML += `
                <div class="flex items-center gap-3 text-gray-600 dark:text-gray-400">
                    <i class="fas fa-heart w-5 text-gray-400"></i>
                    <span>${getRelationshipText(user.relationship)}</span>
                </div>`;
        }
        
        if (!infoHTML) {
            infoHTML = '<p class="text-gray-500 text-center">Nincs megadva információ</p>';
        }
        
        infoContent.innerHTML = infoHTML;
        
        // URL frissítése username-re (csak ha még nem ott vagyunk)
        if (user.username && window.location.pathname !== `/${user.username}`) {
            window.history.pushState({}, '', `/${user.username}`);
        }
        
        // Actions - barát státusz lekérése
        const actions = document.getElementById('profileActions');
        if (userId === currentUser._id) {
            actions.innerHTML = `
                <button onclick="showSettings()" class="px-4 py-2 bg-gray-200 dark:bg-dark-300 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-dark-400 transition">
                    <i class="fas fa-pen mr-2"></i>Profil szerkesztése
                </button>
            `;
        } else {
            // Barát státusz lekérése
            const friendStatus = await api(`/friends/status/${userId}`);
            let friendButton = '';
            
            switch (friendStatus.status) {
                case 'friends':
                    friendButton = `
                        <button onclick="removeFriend('${userId}')" class="px-4 py-2 bg-gray-200 dark:bg-dark-300 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 transition group">
                            <i class="fas fa-user-check mr-2 group-hover:hidden"></i>
                            <i class="fas fa-user-minus mr-2 hidden group-hover:inline"></i>
                            <span class="group-hover:hidden">Barátok</span>
                            <span class="hidden group-hover:inline">Barátság törlése</span>
                        </button>
                    `;
                    break;
                case 'request_sent':
                    friendButton = `
                        <button onclick="cancelFriendRequest('${userId}')" class="px-4 py-2 bg-gray-200 dark:bg-dark-300 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 transition">
                            <i class="fas fa-user-clock mr-2"></i>Kérelem elküldve
                        </button>
                    `;
                    break;
                case 'request_received':
                    friendButton = `
                        <button onclick="acceptFriend('${friendStatus.requestId}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition">
                            <i class="fas fa-user-check mr-2"></i>Elfogadás
                        </button>
                        <button onclick="declineFriend('${friendStatus.requestId}')" class="px-4 py-2 bg-gray-200 dark:bg-dark-300 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-dark-400 transition">
                            <i class="fas fa-times mr-2"></i>Elutasítás
                        </button>
                    `;
                    break;
                default:
                    friendButton = `
                        <button onclick="sendFriendRequest('${userId}')" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-medium transition">
                            <i class="fas fa-user-plus mr-2"></i>Barátnak jelölés
                        </button>
                    `;
            }
            
            actions.innerHTML = `
                ${friendButton}
                <button onclick="openChatWindow('${userId}')" class="px-4 py-2 bg-gray-200 dark:bg-dark-300 text-gray-700 dark:text-gray-300 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-dark-400 transition">
                    <i class="fab fa-facebook-messenger mr-2"></i>Üzenet
                </button>
            `;
        }
        
        renderPosts(posts, 'profilePosts');
    } catch (e) {
        toast('Felhasználó nem található!', 'error');
        navigate('feed');
    }
}

async function cancelFriendRequest(userId) {
    try {
        await api(`/friends/request/${userId}`, { method: 'DELETE' });
        toast('Barátkérelem visszavonva!', 'info');
        loadProfile(userId);
    } catch (e) {}
}

async function removeFriend(userId) {
    if (!confirm('Biztosan törlöd a barátságot?')) return;
    try {
        await api(`/friends/${userId}`, { method: 'DELETE' });
        currentUser = await api('/auth/me');
        toast('Barátság törölve!', 'info');
        loadProfile(userId);
    } catch (e) {}
}

// ============ NOTIFICATIONS ============
async function loadNotifications() {
    try {
        const notifs = await api('/notifications');
        await api('/notifications/read', { method: 'PUT' });
        updateBadges();
        
        const container = document.getElementById('notificationsList');
        const icons = { like: 'thumbs-up', comment: 'comment', friend: 'user-plus', message: 'comment-dots' };
        const colors = { like: 'bg-blue-500', comment: 'bg-green-500', friend: 'bg-purple-500', message: 'bg-pink-500' };
        
        container.innerHTML = notifs.length ? notifs.map(n => `
            <div class="flex items-center gap-4 p-4 hover:bg-gray-50 dark:hover:bg-dark-300 transition ${!n.read ? 'bg-blue-50 dark:bg-blue-900/10' : ''}">
                <div class="w-12 h-12 ${colors[n.type]} rounded-full flex items-center justify-center text-white">
                    <i class="fas fa-${icons[n.type]}"></i>
                </div>
                <div class="flex-1">
                    <p class="text-gray-800 dark:text-white">${n.text}</p>
                    <p class="text-sm text-gray-500">${timeAgo(n.createdAt)}</p>
                </div>
                ${!n.read ? '<div class="w-3 h-3 bg-blue-500 rounded-full"></div>' : ''}
            </div>
        `).join('') : '<p class="text-center text-gray-500 py-12">Nincs értesítés</p>';
    } catch (e) {}
}

// ============ SETTINGS ============
let canChangeUsername = true;
let originalUsername = '';

function showSettings() {
    document.getElementById('settingsModal').classList.remove('hidden');
    document.getElementById('settingsFirstName').value = currentUser.firstName || '';
    document.getElementById('settingsLastName').value = currentUser.lastName || '';
    document.getElementById('settingsUsername').value = currentUser.username || '';
    originalUsername = currentUser.username || '';
    document.getElementById('settingsAvatar').value = currentUser.avatar || '';
    document.getElementById('settingsCover').value = currentUser.cover || '';
    document.getElementById('settingsBio').value = currentUser.bio || '';
    
    // Új mezők
    document.getElementById('settingsWorkplace').value = currentUser.workplace || '';
    document.getElementById('settingsJobTitle').value = currentUser.jobTitle || '';
    document.getElementById('settingsSchool').value = currentUser.school || '';
    document.getElementById('settingsCollege').value = currentUser.college || '';
    document.getElementById('settingsCurrentCity').value = currentUser.currentCity || '';
    document.getElementById('settingsHometown').value = currentUser.hometown || '';
    document.getElementById('settingsRelationship').value = currentUser.relationship || '';
    
    document.getElementById('userMenu').classList.add('hidden');
    
    // Vezetéknév kötelező jelzés (tulajdonosnak nem kötelező)
    const lastNameRequired = document.getElementById('lastNameRequired');
    if (currentUser.isOwner) {
        lastNameRequired.textContent = '(opcionális)';
        lastNameRequired.className = 'text-gray-400 text-xs';
    } else {
        lastNameRequired.textContent = '*';
        lastNameRequired.className = '';
    }
    
    // Ellenőrizzük, hogy változtatható-e a username
    const hint = document.getElementById('usernameChangeHint');
    if (currentUser.lastUsernameChange) {
        const daysSince = (Date.now() - new Date(currentUser.lastUsernameChange).getTime()) / (1000 * 60 * 60 * 24);
        if (daysSince < 30) {
            const daysLeft = Math.ceil(30 - daysSince);
            hint.textContent = `Még ${daysLeft} napot kell várnod a felhasználónév módosításához`;
            hint.className = 'text-xs text-orange-500 mt-1';
            document.getElementById('settingsUsername').disabled = true;
            canChangeUsername = false;
        } else {
            hint.textContent = 'Havonta egyszer módosíthatod a felhasználóneved';
            hint.className = 'text-xs text-gray-500 mt-1';
            document.getElementById('settingsUsername').disabled = false;
            canChangeUsername = true;
        }
    } else {
        hint.textContent = 'Havonta egyszer módosíthatod a felhasználóneved';
        hint.className = 'text-xs text-gray-500 mt-1';
        document.getElementById('settingsUsername').disabled = false;
        canChangeUsername = true;
    }
}

let newUsernameCheckTimeout;
async function checkNewUsername(username) {
    const hint = document.getElementById('usernameChangeHint');
    
    if (!canChangeUsername) return;
    
    if (username === originalUsername) {
        hint.textContent = 'Havonta egyszer módosíthatod a felhasználóneved';
        hint.className = 'text-xs text-gray-500 mt-1';
        return;
    }
    
    if (username.length < 3) {
        hint.textContent = 'Minimum 3 karakter szükséges';
        hint.className = 'text-xs text-orange-500 mt-1';
        return;
    }
    
    if (!/^[a-zA-Z0-9._]+$/.test(username)) {
        hint.textContent = 'Csak betűk, számok, pont és aláhúzás használható';
        hint.className = 'text-xs text-red-500 mt-1';
        return;
    }
    
    clearTimeout(newUsernameCheckTimeout);
    newUsernameCheckTimeout = setTimeout(async () => {
        try {
            const res = await fetch(`${API}/auth/check-username/${username}`);
            const data = await res.json();
            if (data.available) {
                hint.textContent = 'Ez a felhasználónév elérhető!';
                hint.className = 'text-xs text-green-500 mt-1';
            } else {
                hint.textContent = 'Ez a felhasználónév már foglalt!';
                hint.className = 'text-xs text-red-500 mt-1';
            }
        } catch (e) {}
    }, 500);
}

function closeSettings() {
    document.getElementById('settingsModal').classList.add('hidden');
}

async function saveSettings() {
    try {
        const firstName = document.getElementById('settingsFirstName').value.trim();
        const lastName = document.getElementById('settingsLastName').value.trim();
        
        // Ellenőrzések
        if (!firstName) {
            return toast('A keresztnév megadása kötelező!', 'error');
        }
        
        if (!currentUser.isOwner && !lastName) {
            return toast('A vezetéknév megadása kötelező!', 'error');
        }
        
        const newUsername = document.getElementById('settingsUsername').value.trim();
        
        // Ha a username változott és változtatható
        if (canChangeUsername && newUsername !== originalUsername && newUsername.length >= 3) {
            try {
                const usernameResult = await api('/users/username', {
                    method: 'PUT',
                    body: JSON.stringify({ username: newUsername })
                });
                currentUser = usernameResult;
            } catch (e) {
                // Ha hiba van a username váltásnál, az error toast már megjelenik
                return;
            }
        }
        
        // Profil adatok mentése
        const data = await api('/users/profile', {
            method: 'PUT',
            body: JSON.stringify({
                firstName,
                lastName,
                avatar: document.getElementById('settingsAvatar').value,
                cover: document.getElementById('settingsCover').value,
                bio: document.getElementById('settingsBio').value,
                workplace: document.getElementById('settingsWorkplace').value,
                jobTitle: document.getElementById('settingsJobTitle').value,
                school: document.getElementById('settingsSchool').value,
                college: document.getElementById('settingsCollege').value,
                currentCity: document.getElementById('settingsCurrentCity').value,
                hometown: document.getElementById('settingsHometown').value,
                relationship: document.getElementById('settingsRelationship').value
            })
        });
        currentUser = data;
        updateUserUI();
        closeSettings();
        toast('Beállítások mentve!', 'success');
        if (document.getElementById('profilePage').classList.contains('hidden') === false) {
            loadProfile(currentUser._id);
        }
    } catch (e) {}
}

// ============ ADMIN ============
async function loadAdmin() {
    if (!currentUser.isAdmin) return navigate('feed');
    
    try {
        const stats = await api('/admin/stats');
        const users = await api('/admin/users');
        
        document.getElementById('adminUsers').textContent = stats.users;
        document.getElementById('adminPosts').textContent = stats.posts;
        document.getElementById('adminMessages').textContent = stats.messages;
        
        document.getElementById('adminUserList').innerHTML = users.map(u => {
            const userName = getUserName(u);
            let badge = '';
            if (u.isOwner) {
                badge = '<span class="ml-2 text-xs bg-gradient-to-r from-amber-500 to-orange-500 text-white px-2 py-0.5 rounded-full"><i class="fas fa-crown mr-1"></i>Tulajdonos</span>';
            } else if (u.isAdmin) {
                badge = '<span class="ml-2 text-xs bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-2 py-0.5 rounded-full"><i class="fas fa-shield-alt mr-1"></i>Admin</span>';
            }
            
            // Törlés: owner mindent törölhet (kivéve magát), admin csak nem-admint
            const canDelete = !u.isOwner && (currentUser.isOwner || !u.isAdmin);
            
            // Admin jog: csak owner adhat/vehet el
            const canToggleAdmin = currentUser.isOwner && !u.isOwner;
            
            return `
                <div class="flex items-center gap-4 p-3 bg-gray-50 dark:bg-dark-300 rounded-xl">
                    <img src="${getAvatar(u)}" class="w-10 h-10 rounded-full cursor-pointer" onclick="navigateToProfile('${u.username || u._id}')">
                    <div class="flex-1">
                        <p class="font-semibold text-gray-800 dark:text-white text-sm cursor-pointer hover:underline" onclick="navigateToProfile('${u.username || u._id}')">
                            ${userName}${badge}
                        </p>
                        <p class="text-xs text-gray-500">${u.email} · @${u.username || 'user'}</p>
                    </div>
                    <div class="flex items-center gap-1">
                        ${canToggleAdmin ? `
                            <button onclick="toggleAdmin('${u._id}', ${u.isAdmin})" class="px-3 py-1.5 rounded-lg text-xs font-medium transition ${u.isAdmin 
                                ? 'bg-red-100 dark:bg-red-900/30 text-red-600 hover:bg-red-200 dark:hover:bg-red-900/50' 
                                : 'bg-purple-100 dark:bg-purple-900/30 text-purple-600 hover:bg-purple-200 dark:hover:bg-purple-900/50'}">
                                <i class="fas fa-${u.isAdmin ? 'user-minus' : 'user-shield'} mr-1"></i>
                                ${u.isAdmin ? 'Admin elvétele' : 'Admin adása'}
                            </button>
                        ` : ''}
                        ${canDelete ? `
                            <button onclick="deleteUser('${u._id}')" class="w-8 h-8 rounded-full hover:bg-red-100 dark:hover:bg-red-900/30 flex items-center justify-center transition" title="Törlés">
                                <i class="fas fa-trash text-red-500 text-sm"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    } catch (e) {}
}

async function toggleAdmin(userId, currentlyAdmin) {
    const action = currentlyAdmin ? 'elvenni' : 'adni';
    if (!confirm(`Biztosan szeretnéd ${action} az admin jogot?`)) return;
    
    try {
        const result = await api(`/admin/toggle-admin/${userId}`, { method: 'POST' });
        toast(result.message, 'success');
        loadAdmin();
    } catch (e) {}
}

async function deleteUser(userId) {
    if (!confirm('Biztosan törlöd ezt a felhasználót?')) return;
    try {
        await api(`/admin/users/${userId}`, { method: 'DELETE' });
        toast('Felhasználó törölve!', 'success');
        loadAdmin();
    } catch (e) {}
}

// ============ INIT ============
if (localStorage.getItem('darkMode') === 'true') {
    document.documentElement.classList.add('dark');
    document.getElementById('themeIcon').className = 'fas fa-sun text-gray-700 dark:text-gray-300';
}

// URL alapú routing kezelése
function handleURLRouting() {
    const path = window.location.pathname;
    
    // Ha van path (nem csak "/")
    if (path && path !== '/' && path.length > 1) {
        const pathPart = path.substring(1); // Levágja a "/" jelet
        
        // Ellenőrizzük, hogy nem egy API vagy rendszer útvonal-e
        if (!pathPart.startsWith('api/') && !pathPart.includes('.')) {
            // Profil oldal megnyitása username alapján
            navigate('profile', pathPart);
            return;
        }
    }
    
    // Alapértelmezett oldal
    navigate('feed');
}

if (token) {
    api('/auth/me').then(user => {
        currentUser = user;
        initApp().then(() => {
            // URL routing kezelése bejelentkezés után
            handleURLRouting();
        });
    }).catch(() => {
        localStorage.removeItem('token');
        token = null;
    });
}

// Böngésző vissza/előre gomb kezelése
window.addEventListener('popstate', () => {
    if (currentUser) {
        handleURLRouting();
    }
});

// Close menus on outside click
document.addEventListener('click', (e) => {
    if (!e.target.closest('#userMenu') && !e.target.closest('[onclick="toggleUserMenu()"]')) {
        document.getElementById('userMenu').classList.add('hidden');
    }
});

// ============ RIGHT SIDEBAR ============
async function loadRightSidebar() {
    try {
        const user = await api(`/users/${currentUser._id}`);
        currentUser.friends = user.friends; // Frissítjük a currentUser barátait is
        const friends = user.friends || [];
        
        // Online barátok
        const onlineFriends = friends.filter(f => f.isOnline);
        const offlineFriends = friends.filter(f => !f.isOnline);
        
        const onlineContainer = document.getElementById('sidebarOnlineFriends');
        if (onlineFriends.length > 0) {
            onlineContainer.innerHTML = onlineFriends.map(f => `
                <div onclick="openChatWindow('${f._id}')" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 cursor-pointer transition">
                    <div class="relative">
                        <img src="${getAvatar(f)}" class="w-9 h-9 rounded-full">
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 border-2 border-white dark:border-dark-200 rounded-full"></span>
                    </div>
                    <span class="font-medium text-gray-800 dark:text-white text-sm truncate">${getUserName(f)}</span>
                </div>
            `).join('');
        } else {
            onlineContainer.innerHTML = '<p class="text-gray-500 text-sm py-2">Nincs online barát</p>';
        }
        
        // Összes barát
        const allContainer = document.getElementById('sidebarAllFriends');
        if (offlineFriends.length > 0) {
            allContainer.innerHTML = offlineFriends.map(f => `
                <div onclick="openChatWindow('${f._id}')" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 cursor-pointer transition">
                    <div class="relative">
                        <img src="${getAvatar(f)}" class="w-9 h-9 rounded-full">
                        <span class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-gray-400 border-2 border-white dark:border-dark-200 rounded-full"></span>
                    </div>
                    <span class="font-medium text-gray-600 dark:text-gray-400 text-sm truncate">${getUserName(f)}</span>
                </div>
            `).join('');
        } else if (friends.length === 0) {
            allContainer.innerHTML = '<p class="text-gray-500 text-sm py-2">Még nincsenek barátaid</p>';
        } else {
            allContainer.innerHTML = '';
        }
        
        // Csoportok betöltése
        await loadSidebarGroups();
    } catch (e) {
        console.error('Sidebar error:', e);
    }
}

async function loadSidebarGroups() {
    try {
        allGroups = await api('/groups');
        const container = document.getElementById('sidebarGroups');
        
        if (allGroups.length > 0) {
            container.innerHTML = allGroups.map(g => `
                <div onclick="openGroupChat('${g._id}')" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-300 cursor-pointer transition">
                    <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                        ${g.image ? `<img src="${g.image}" class="w-9 h-9 rounded-full object-cover">` : `<i class="fas fa-users text-white text-sm"></i>`}
                    </div>
                    <div class="flex-1 min-w-0">
                        <span class="font-medium text-gray-800 dark:text-white text-sm truncate block">${g.name}</span>
                        <span class="text-xs text-gray-500">${g.members.length} tag</span>
                    </div>
                    ${g.unreadCount > 0 ? `<span class="bg-blue-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">${g.unreadCount}</span>` : ''}
                </div>
            `).join('');
        } else {
            container.innerHTML = '<p class="text-gray-500 text-sm py-2">Nincs még csoportod</p>';
        }
    } catch (e) {
        console.error('Groups error:', e);
    }
}

// ============ GROUP FUNCTIONS ============
function openCreateGroupModal() {
    document.getElementById('createGroupModal').classList.remove('hidden');
    selectedGroupMembers.clear();
    document.getElementById('groupName').value = '';
    document.getElementById('groupImage').value = '';
    document.getElementById('selectedMembers').innerHTML = '';
    
    // Barátok listája
    const container = document.getElementById('groupMembersList');
    const friends = currentUser.friends || [];
    
    if (friends.length > 0) {
        // Szűrjük ki a barátokat az összes user közül
        const friendUsers = allUsers.filter(u => friends.some(f => (f._id || f) === u._id));
        container.innerHTML = friendUsers.map(f => `
            <label class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-dark-400 cursor-pointer transition">
                <input type="checkbox" value="${f._id}" onchange="toggleGroupMember('${f._id}', '${getUserName(f)}', '${getAvatar(f)}')" 
                    class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                <img src="${getAvatar(f)}" class="w-8 h-8 rounded-full">
                <span class="text-gray-800 dark:text-white text-sm">${getUserName(f)}</span>
            </label>
        `).join('');
    } else {
        container.innerHTML = '<p class="text-gray-500 text-sm py-4 text-center">Először adj hozzá barátokat!</p>';
    }
}

function closeCreateGroupModal() {
    document.getElementById('createGroupModal').classList.add('hidden');
}

function toggleGroupMember(userId, name, avatar) {
    const container = document.getElementById('selectedMembers');
    
    if (selectedGroupMembers.has(userId)) {
        selectedGroupMembers.delete(userId);
        document.getElementById(`selected-${userId}`)?.remove();
    } else {
        selectedGroupMembers.add(userId);
        const tag = document.createElement('span');
        tag.id = `selected-${userId}`;
        tag.className = 'inline-flex items-center gap-1 bg-blue-100 dark:bg-blue-900/30 text-blue-600 px-2 py-1 rounded-full text-xs';
        tag.innerHTML = `
            <img src="${avatar}" class="w-4 h-4 rounded-full">
            ${name}
            <button onclick="removeGroupMember('${userId}')" class="hover:text-red-500">
                <i class="fas fa-times"></i>
            </button>
        `;
        container.appendChild(tag);
    }
}

function removeGroupMember(userId) {
    selectedGroupMembers.delete(userId);
    document.getElementById(`selected-${userId}`)?.remove();
    const checkbox = document.querySelector(`#groupMembersList input[value="${userId}"]`);
    if (checkbox) checkbox.checked = false;
}

async function createGroup() {
    const name = document.getElementById('groupName').value.trim();
    const image = document.getElementById('groupImage').value.trim();
    
    if (!name) {
        return toast('Add meg a csoport nevét!', 'error');
    }
    
    if (selectedGroupMembers.size < 1) {
        return toast('Válassz legalább egy tagot!', 'error');
    }
    
    try {
        const members = Array.from(selectedGroupMembers);
        members.push(currentUser._id); // Magamat is hozzáadom
        
        await api('/groups', {
            method: 'POST',
            body: JSON.stringify({ name, image, members })
        });
        
        closeCreateGroupModal();
        loadSidebarGroups();
        toast('Csoport létrehozva!', 'success');
    } catch (e) {}
}

async function openGroupChat(groupId) {
    try {
        const group = await api(`/groups/${groupId}`);
        currentGroupChat = group;
        
        // Join socket room
        socket.emit('joinGroup', groupId);
        
        document.getElementById('groupChatModal').classList.remove('hidden');
        
        // Header
        document.getElementById('groupChatHeader').innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
                    ${group.image ? `<img src="${group.image}" class="w-10 h-10 rounded-full object-cover">` : `<i class="fas fa-users text-white"></i>`}
                </div>
                <div>
                    <p class="font-semibold text-gray-800 dark:text-white">${group.name}</p>
                    <p class="text-xs text-gray-500">${group.members.length} tag</p>
                </div>
            </div>
            <div class="flex items-center gap-1">
                <button onclick="startGroupCall('${group._id}', 'audio')" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition" title="Csoportos hanghívás">
                    <i class="fas fa-phone"></i>
                </button>
                <button onclick="startGroupCall('${group._id}', 'video')" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-blue-500 transition" title="Csoportos videóhívás">
                    <i class="fas fa-video"></i>
                </button>
                <button onclick="openGroupInfoModal('${group._id}')" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-gray-500 transition" title="Csoport beállítások">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button onclick="closeGroupChat()" class="w-9 h-9 rounded-full hover:bg-gray-100 dark:hover:bg-dark-300 flex items-center justify-center text-gray-500 transition">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        await loadGroupMessages(groupId);
    } catch (e) {}
}

function closeGroupChat() {
    if (currentGroupChat) {
        socket.emit('leaveGroup', currentGroupChat._id);
    }
    document.getElementById('groupChatModal').classList.add('hidden');
    currentGroupChat = null;
}

async function loadGroupMessages(groupId) {
    try {
        const messages = await api(`/groups/${groupId}/messages`);
        const container = document.getElementById('groupChatMessages');
        
        if (messages.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-500 py-8">Még nincs üzenet ebben a csoportban</p>';
            return;
        }
        
        container.innerHTML = messages.map(m => {
            const isMe = m.from._id === currentUser._id;
            const senderName = getUserName(m.from);
            const badge = getUserBadge(m.from);
            
            return `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="flex gap-2 max-w-md ${isMe ? 'flex-row-reverse' : ''}">
                        ${!isMe ? `<img src="${getAvatar(m.from)}" class="w-8 h-8 rounded-full flex-shrink-0">` : ''}
                        <div>
                            ${!isMe ? `<p class="text-xs text-gray-500 mb-1">${senderName}${badge}</p>` : ''}
                            <div class="${isMe 
                                ? 'bg-blue-500 text-white' 
                                : 'bg-gray-200 dark:bg-dark-300 text-gray-800 dark:text-white'} rounded-2xl px-4 py-2">
                                ${m.text}
                            </div>
                            <p class="text-xs text-gray-400 mt-1 ${isMe ? 'text-right' : ''}">${timeAgo(m.createdAt)}</p>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.scrollTop = container.scrollHeight;
    } catch (e) {}
}

let groupTypingTimeout;
function handleGroupTyping() {
    if (currentGroupChat) {
        socket.emit('groupTyping', { groupId: currentGroupChat._id, userId: currentUser._id, userName: getUserName(currentUser) });
        clearTimeout(groupTypingTimeout);
        groupTypingTimeout = setTimeout(() => {
            socket.emit('stopGroupTyping', { groupId: currentGroupChat._id, userId: currentUser._id });
        }, 1000);
    }
}

async function sendGroupMessage() {
    const input = document.getElementById('groupChatInput');
    const text = input.value.trim();
    if (!text || !currentGroupChat) return;
    
    try {
        await api(`/groups/${currentGroupChat._id}/messages`, {
            method: 'POST',
            body: JSON.stringify({ text })
        });
        input.value = '';
        socket.emit('stopGroupTyping', { groupId: currentGroupChat._id, userId: currentUser._id });
    } catch (e) {}
}

async function openGroupInfoModal(groupId) {
    try {
        const group = await api(`/groups/${groupId}`);
        document.getElementById('groupInfoModal').classList.remove('hidden');
        
        const isAdmin = group.admins.some(a => (a._id || a) === currentUser._id);
        const isCreator = (group.creator._id || group.creator) === currentUser._id;
        
        document.getElementById('groupInfoContent').innerHTML = `
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    ${group.image ? `<img src="${group.image}" class="w-20 h-20 rounded-full object-cover">` : `<i class="fas fa-users text-white text-2xl"></i>`}
                </div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">${group.name}</h3>
                <p class="text-gray-500 text-sm">${group.members.length} tag</p>
            </div>
            
            <div class="mb-4">
                <h4 class="font-semibold text-gray-800 dark:text-white mb-2">Tagok</h4>
                <div class="space-y-2 max-h-48 overflow-y-auto">
                    ${group.members.map(m => {
                        const memberIsAdmin = group.admins.some(a => (a._id || a) === m._id);
                        const memberIsCreator = (group.creator._id || group.creator) === m._id;
                        return `
                            <div class="flex items-center justify-between p-2 bg-gray-50 dark:bg-dark-300 rounded-lg">
                                <div class="flex items-center gap-2">
                                    <img src="${getAvatar(m)}" class="w-8 h-8 rounded-full">
                                    <div>
                                        <p class="text-sm font-medium text-gray-800 dark:text-white">${getUserName(m)}${getUserBadge(m)}</p>
                                        <p class="text-xs text-gray-500">
                                            ${memberIsCreator ? 'Létrehozó' : memberIsAdmin ? 'Admin' : 'Tag'}
                                        </p>
                                    </div>
                                </div>
                                ${isAdmin && !memberIsCreator && m._id !== currentUser._id ? `
                                    <button onclick="removeMemberFromGroup('${group._id}', '${m._id}')" class="text-red-500 hover:text-red-600 text-sm">
                                        <i class="fas fa-user-minus"></i>
                                    </button>
                                ` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
            
            ${isAdmin ? `
                <div class="mb-4">
                    <button onclick="showAddMembersToGroup('${group._id}')" class="w-full py-2 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-lg font-medium hover:bg-blue-200 dark:hover:bg-blue-900/50 transition">
                        <i class="fas fa-user-plus mr-2"></i>Tagok hozzáadása
                    </button>
                </div>
            ` : ''}
            
            <div class="border-t border-gray-200 dark:border-dark-300 pt-4">
                <button onclick="leaveGroup('${group._id}')" class="w-full py-2 bg-red-100 dark:bg-red-900/30 text-red-600 rounded-lg font-medium hover:bg-red-200 dark:hover:bg-red-900/50 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i>Kilépés a csoportból
                </button>
            </div>
        `;
    } catch (e) {}
}

function closeGroupInfoModal() {
    document.getElementById('groupInfoModal').classList.add('hidden');
}

async function removeMemberFromGroup(groupId, memberId) {
    if (!confirm('Biztosan eltávolítod ezt a tagot?')) return;
    try {
        await api(`/groups/${groupId}/members/${memberId}`, { method: 'DELETE' });
        openGroupInfoModal(groupId);
        toast('Tag eltávolítva!', 'success');
    } catch (e) {}
}

async function leaveGroup(groupId) {
    if (!confirm('Biztosan kilépsz a csoportból?')) return;
    try {
        await api(`/groups/${groupId}/leave`, { method: 'POST' });
        closeGroupInfoModal();
        closeGroupChat();
        loadSidebarGroups();
        toast('Kiléptél a csoportból!', 'info');
    } catch (e) {}
}

function startGroupCall(groupId, type) {
    toast(`Csoportos ${type === 'video' ? 'videó' : 'hang'}hívás indítása...`, 'info');
    // Itt lenne a csoportos hívás logika
}
</script>

</body>
</html>
